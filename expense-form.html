<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Expense Report - TrevID</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <style>
        .policy-indicator {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .policy-indicator.violation {
            background: #fce8e6;
            color: #ea4335;
            border: 1px solid #f28b82;
        }
        
        .policy-indicator.warning {
            background: #fef7e0;
            color: #f9ab00;
            border: 1px solid #fbbc04;
        }
        
        .policy-indicator.ok {
            background: #e8f5e8;
            color: #34a853;
            border: 1px solid #81c995;
        }
        
        .justification-section {
            margin-top: 16px;
            padding: 16px;
            background: #fef7e0;
            border: 1px solid #fbbc04;
            border-radius: 8px;
        }
        
        .justification-section .form-group {
            margin-bottom: 12px;
        }
        
        .justification-section .form-group:last-child {
            margin-bottom: 0;
        }
        
        .justification-section label {
            font-weight: 600;
            color: #ea4335;
        }
        
        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: #ea4335;
            box-shadow: 0 0 0 2px rgba(234, 67, 53, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img 
                    class="brand-logo" 
                    src="assets/brand/trevid_logo.png" 
                    srcset="/assets/brand/trevid_logo.png 1x, /assets/brand/trevid_logo@2x.png 2x" 
                    alt="TrevID â€“ Business Companion" />
            </div>
            <div class="user-info">
                <span>Hello, John Doe</span>
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="travel.html" class="nav-item">
            <i class="fas fa-plane"></i>
            <span>Travel</span>
        </a>
        <a href="vehicle.html" class="nav-item">
            <i class="fas fa-car"></i>
            <span>Vehicle</span>
        </a>
        <a href="expenses.html" class="nav-item active">
            <i class="fas fa-receipt"></i>
            <span>Expenses</span>
        </a>
        <a href="approvals.html" class="nav-item">
            <i class="fas fa-check-circle"></i>
            <span>Approvals</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Back Navigation -->
            <div class="back-nav">
                <a href="expenses.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Expense Reports
                </a>
            </div>

            <!-- Form Header -->
            <section class="form-header">
                <h1><i class="fas fa-plus-circle"></i> Create New Expense Report</h1>
                <p class="form-subtitle">Fill in the basic information to create your expense report</p>
            </section>

            <!-- Create Form -->
            <section class="expense-form-container">
                <form class="expense-form" id="createExpenseForm">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reportTitle">Report Title *</label>
                                <input type="text" id="reportTitle" name="reportTitle" placeholder="e.g., Trip to Jakarta Feb 2024" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDate">Start Date *</label>
                                <input type="date" id="startDate" name="startDate" required onchange="validateDateRange()">
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date *</label>
                                <input type="date" id="endDate" name="endDate" required onchange="validateDateRange()">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="costCenter">Cost Center *</label>
                                <select id="costCenter" name="costCenter" required>
                                    <option value="">Select Cost Center</option>
                                    <option value="CC001">Marketing - CC001</option>
                                    <option value="CC002">Sales - CC002</option>
                                    <option value="CC003">IT - CC003</option>
                                    <option value="CC004">Finance - CC004</option>
                                    <option value="CC005">Operations - CC005</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="project">Project (Optional)</label>
                                <select id="project" name="project">
                                    <option value="">Select Project (Optional)</option>
                                    <option value="PRJ001">Q1 Campaign - PRJ001</option>
                                    <option value="PRJ002">System Upgrade - PRJ002</option>
                                    <option value="PRJ003">Market Research - PRJ003</option>
                                    <option value="PRJ004">Product Launch - PRJ004</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currency">Primary Currency *</label>
                                <select id="currency" name="currency" required>
                                    <option value="IDR">IDR - Indonesian Rupiah</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="SGD">SGD - Singapore Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="MYR">MYR - Malaysian Ringgit</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="purpose">Business Purpose *</label>
                                <select id="purpose" name="purpose" required>
                                    <option value="">Select Purpose</option>
                                    <option value="business-trip">Business Trip</option>
                                    <option value="client-meeting">Client Meeting</option>
                                    <option value="conference">Conference/Training</option>
                                    <option value="site-visit">Site Visit</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3" placeholder="Brief description of the business purpose and activities..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Quick Add Options -->
                    <div class="form-section">
                        <h3>Quick Add Items (Optional)</h3>
                        <p class="section-subtitle">You can add items now or after creating the report</p>
                        
                        <div class="quick-add-options">
                            <div class="quick-add-card" onclick="toggleQuickAdd('flight')">
                                <div class="quick-add-header">
                                    <i class="fas fa-plane"></i>
                                    <span>Add Flight</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="quick-add-content" id="quickAddFlight" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="flightFrom">From</label>
                                            <select id="flightFrom" name="flightFrom">
                                                <option value="">Select departure city</option>
                                                <option value="CGK">CGK - Jakarta</option>
                                                <option value="SUB">SUB - Surabaya</option>
                                                <option value="DPS">DPS - Denpasar</option>
                                                <option value="MLG">MLG - Malang</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="flightTo">To</label>
                                            <select id="flightTo" name="flightTo">
                                                <option value="">Select destination city</option>
                                                <option value="CGK">CGK - Jakarta</option>
                                                <option value="SUB">SUB - Surabaya</option>
                                                <option value="DPS">DPS - Denpasar</option>
                                                <option value="MLG">MLG - Malang</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="flightDate">Date</label>
                                            <input type="date" id="flightDate" name="flightDate">
                                        </div>
                                        <div class="form-group">
                                            <label for="flightAmount">Estimated Amount</label>
                                            <input type="number" id="flightAmount" name="flightAmount" placeholder="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="quick-add-card" onclick="toggleQuickAdd('hotel')">
                                <div class="quick-add-header">
                                    <i class="fas fa-bed"></i>
                                    <span>Add Hotel</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="quick-add-content" id="quickAddHotel" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="hotelCity">City</label>
                                            <select id="hotelCity" name="hotelCity">
                                                <option value="">Select city</option>
                                                <option value="jakarta">Jakarta</option>
                                                <option value="surabaya">Surabaya</option>
                                                <option value="bandung">Bandung</option>
                                                <option value="yogyakarta">Yogyakarta</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="hotelNights">Nights</label>
                                            <input type="number" id="hotelNights" name="hotelNights" placeholder="1" min="1">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="hotelCheckIn">Check-in</label>
                                            <input type="date" id="hotelCheckIn" name="hotelCheckIn">
                                        </div>
                                        <div class="form-group">
                                            <label for="hotelAmount">Estimated Amount</label>
                                            <input type="number" id="hotelAmount" name="hotelAmount" placeholder="0" step="0.01" oninput="checkHotelPolicy()">
                                            <div class="policy-indicator" id="hotelPolicyIndicator" style="display: none;"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hotel Policy Justification -->
                                    <div class="justification-section" id="hotelJustification" style="display: none;">
                                        <div class="form-group">
                                            <label for="hotelViolationReason">Violation Reason *</label>
                                            <select id="hotelViolationReason" name="hotelViolationReason" onchange="toggleHotelCustomReason()">
                                                <option value="">Select reason for policy violation</option>
                                                <option value="client_request">Client Request</option>
                                                <option value="no_lower_rate">No Lower Rate Available</option>
                                                <option value="location_constraint">Location Constraint</option>
                                                <option value="last_minute_booking">Last Minute Booking</option>
                                                <option value="business_necessity">Business Necessity</option>
                                                <option value="other">Other (specify below)</option>
                                            </select>
                                        </div>
                                        <div class="form-group" id="hotelCustomReasonGroup" style="display: none;">
                                            <label for="hotelCustomReason">Custom Reason</label>
                                            <input type="text" id="hotelCustomReason" name="hotelCustomReason" placeholder="Please specify the reason...">
                                        </div>
                                        <div class="form-group">
                                            <label for="hotelJustificationNotes">Additional Details</label>
                                            <textarea id="hotelJustificationNotes" name="hotelJustificationNotes" rows="2" placeholder="Provide additional details or context for this violation..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Import Hint -->
                        <div class="import-hint">
                            <i class="fas fa-info-circle"></i>
                            <span>Semua data booking dari modul Travel dapat diimpor dari tombol 'Add from Bookings' di halaman detail.</span>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='expenses.html'">Cancel</button>
                        <button type="button" class="btn btn-outline" onclick="saveDraft()">Save as Draft</button>
                        <button type="submit" class="btn btn-primary">Create Report</button>
                    </div>
                </form>
            </section>
        </div>
    </main>

    <script>
        // Form validation
        function validateDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                if (new Date(endDate) < new Date(startDate)) {
                    document.getElementById('endDate').setCustomValidity('End date must be after start date');
                } else {
                    document.getElementById('endDate').setCustomValidity('');
                }
            }
        }
        
        // Quick add toggles
        function toggleQuickAdd(type) {
            const content = document.getElementById(`quickAdd${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const icon = content.parentElement.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Form submission
        document.getElementById('createExpenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate required fields
            const requiredFields = ['reportTitle', 'startDate', 'endDate', 'costCenter', 'currency', 'purpose'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    element.classList.add('error');
                    isValid = false;
                } else {
                    element.classList.remove('error');
                }
            });
            
            // Validate policy justifications
            if (isValid) {
                const hotelJustification = validateHotelJustification();
                if (!hotelJustification.valid) {
                    alert(hotelJustification.message);
                    return;
                }
            }
            
            if (isValid) {
                submitExpenseForm();
            }
        });
        
        function submitExpenseForm() {
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
            submitBtn.disabled = true;
            
            // Disable other buttons
            document.querySelectorAll('.form-actions button').forEach(btn => {
                if (btn !== submitBtn) btn.disabled = true;
            });
            
            // Simulate form submission with potential errors
            setTimeout(() => {
                const success = Math.random() > 0.1; // 90% success rate
                
                if (success) {
                    // Show success message
                    showSuccessMessage('Expense report created successfully!');
                    setTimeout(() => {
                        window.location.href = 'expenses.html';
                    }, 1500);
                } else {
                    // Show error state
                    showErrorMessage('Failed to create expense report. Please check your data and try again.');
                    
                    // Restore buttons
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    document.querySelectorAll('.form-actions button').forEach(btn => {
                        btn.disabled = false;
                    });
                }
            }, 2000);
        }
        
        function saveDraft() {
            const draftBtn = document.querySelector('[onclick="saveDraft()"]');
            const originalText = draftBtn.textContent;
            
            // Show loading state
            draftBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            draftBtn.disabled = true;
            
            // Simulate save draft with potential errors
            setTimeout(() => {
                const success = Math.random() > 0.05; // 95% success rate
                
                if (success) {
                    showSuccessMessage('Draft saved successfully!');
                } else {
                    showErrorMessage('Failed to save draft. Please try again.');
                }
                
                // Restore button
                draftBtn.innerHTML = originalText;
                draftBtn.disabled = false;
            }, 1000);
        }
        
        function showSuccessMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
            `;
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        function showErrorMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            `;
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function continueWithPolicyViolations() {
            // Show policy summary if there are violations
            const hotelAmount = parseFloat(document.getElementById('hotelAmount').value) || 0;
            const hotelNights = parseInt(document.getElementById('hotelNights').value) || 1;
            const perNightAmount = hotelAmount / hotelNights;
            
            let policyMessage = '';
            if (hotelAmount > 0 && perNightAmount > 2000000) {
                const reason = document.getElementById('hotelViolationReason').value;
                const customReason = document.getElementById('hotelCustomReason').value;
                const notes = document.getElementById('hotelJustificationNotes').value;
                
                policyMessage = `\n\nPolicy Violation Detected:\n- Hotel rate exceeds policy (IDR ${perNightAmount.toLocaleString('id-ID')}/night)\n- Reason: ${reason === 'other' ? customReason : reason}\n- Notes: ${notes || 'None'}`;
            }
            
            // Simulate creating report and redirect to detail page
            alert('Expense report created successfully!' + policyMessage);
            window.location.href = 'expense-detail.html';
        }
        
        // Save as draft
        function saveDraft() {
            const formData = new FormData(document.getElementById('createExpenseForm'));
            // Simulate saving draft
            alert('Draft saved successfully!');
            window.location.href = 'expenses.html';
        }
        
        // Auto-populate dates based on business purpose
        document.getElementById('purpose').addEventListener('change', function() {
            const purpose = this.value;
            const today = new Date();
            const startDateField = document.getElementById('startDate');
            const endDateField = document.getElementById('endDate');
            
            if (purpose === 'conference') {
                // Default to 3-day conference
                const start = new Date(today);
                start.setDate(today.getDate() + 7); // Next week
                const end = new Date(start);
                end.setDate(start.getDate() + 2);
                
                startDateField.value = start.toISOString().split('T')[0];
                endDateField.value = end.toISOString().split('T')[0];
            } else if (purpose === 'business-trip') {
                // Default to 2-day business trip
                const start = new Date(today);
                start.setDate(today.getDate() + 3);
                const end = new Date(start);
                end.setDate(start.getDate() + 1);
                
                startDateField.value = start.toISOString().split('T')[0];
                endDateField.value = end.toISOString().split('T')[0];
            }
        });
        
        // Policy validation functions
        function checkHotelPolicy() {
            const amount = parseFloat(document.getElementById('hotelAmount').value) || 0;
            const nights = parseInt(document.getElementById('hotelNights').value) || 1;
            const perNightAmount = amount / nights;
            
            const indicator = document.getElementById('hotelPolicyIndicator');
            const justificationSection = document.getElementById('hotelJustification');
            
            if (amount === 0) {
                indicator.style.display = 'none';
                justificationSection.style.display = 'none';
                return;
            }
            
            // Mock policy rules for hotel
            let status = 'ok';
            let message = '';
            let icon = 'check_circle';
            
            if (perNightAmount > 2000000) { // > 2M IDR per night
                status = 'violation';
                message = `Hotel rate exceeds maximum allowed (IDR 2,000,000/night). Current: IDR ${perNightAmount.toLocaleString('id-ID')}/night`;
                icon = 'error';
                justificationSection.style.display = 'block';
                document.getElementById('hotelViolationReason').required = true;
            } else if (perNightAmount > 1500000) { // > 1.5M IDR per night
                status = 'warning';
                message = `Hotel rate is high (IDR ${perNightAmount.toLocaleString('id-ID')}/night). Consider justification.`;
                icon = 'warning';
                justificationSection.style.display = 'none';
                document.getElementById('hotelViolationReason').required = false;
            } else {
                status = 'ok';
                message = `Hotel rate is within policy (IDR ${perNightAmount.toLocaleString('id-ID')}/night)`;
                icon = 'check_circle';
                justificationSection.style.display = 'none';
                document.getElementById('hotelViolationReason').required = false;
            }
            
            indicator.className = `policy-indicator ${status}`;
            indicator.innerHTML = `<i class="material-icons" style="font-size: 16px;">${icon}</i> ${message}`;
            indicator.style.display = 'flex';
        }
        
        function toggleHotelCustomReason() {
            const reasonSelect = document.getElementById('hotelViolationReason');
            const customReasonGroup = document.getElementById('hotelCustomReasonGroup');
            
            if (reasonSelect.value === 'other') {
                customReasonGroup.style.display = 'block';
                document.getElementById('hotelCustomReason').required = true;
            } else {
                customReasonGroup.style.display = 'none';
                document.getElementById('hotelCustomReason').required = false;
                document.getElementById('hotelCustomReason').value = '';
            }
        }
        
        function validateHotelJustification() {
            const justificationSection = document.getElementById('hotelJustification');
            if (justificationSection.style.display === 'none') {
                return { valid: true };
            }
            
            const reasonSelect = document.getElementById('hotelViolationReason');
            const customReason = document.getElementById('hotelCustomReason');
            
            if (!reasonSelect.value) {
                return { valid: false, message: 'Please select a reason for hotel policy violation' };
            }
            
            if (reasonSelect.value === 'other' && !customReason.value.trim()) {
                return { valid: false, message: 'Please specify the custom reason for hotel violation' };
            }
            
            return { valid: true };
        }
    </script>
</body>
</html>
