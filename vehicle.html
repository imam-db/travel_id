<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle & Mileage - TrevID</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon-192.svg">
</head>
<body>
    <!-- Header with consistent gradient -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img 
                    class="brand-logo" 
                    src="assets/brand/trevid_logo.png" 
                    srcset="/assets/brand/trevid_logo.png 1x, /assets/brand/trevid_logo@2x.png 2x" 
                    alt="TrevID – Business Companion" 
                    width="140" height="36" />
            </div>
            <div class="user-info">
                <span>Hello, John Doe</span>
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header page-container">
            <h1 class="page-title">
                <i class="fas fa-car"></i>
                Vehicle & Mileage
            </h1>
            <p class="page-subtitle">Manage your vehicles and track your trips</p>
        </div>
        
        <!-- KPI Cards -->
        <section class="kpi-section page-container">
            <!-- Aria live region for KPI updates -->
            <div id="kpi-updates" class="sr-only" aria-live="polite" aria-atomic="true"></div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon kpi-blue">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-number" data-count="24">0</h3>
                        <p class="kpi-label">Trips Logged</p>
                        <span class="kpi-period">This Month</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon kpi-amber">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-number" data-count="3">0</h3>
                        <p class="kpi-label">Pending Approval</p>
                        <span class="kpi-period">Awaiting Review</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon kpi-green">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-number" data-count-text="Rp 2.4M">Rp 0</h3>
                        <p class="kpi-label">Est. Cost</p>
                        <span class="kpi-period">This Month</span>
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-icon kpi-red">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="kpi-content">
                        <h3 class="kpi-number" data-count="1">0</h3>
                        <p class="kpi-label">Policy Violations</p>
                        <span class="kpi-period">Needs Attention</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Action Bar -->
        <section class="action-bar page-container">
            <button class="btn-primary" onclick="showNewLogChooser()">
                <i class="fas fa-plus"></i>
                New vehicle log
            </button>

            <div class="tooltip-wrap">
                <button class="btn-secondary disabled" onclick="showImportDialog()" aria-describedby="import-tip" disabled>
                    <i class="fas fa-file-import"></i>
                    Bulk import (CSV/XLSX)
                    <i class="fas fa-info-circle"></i>
                    <span class="availability-note">(Available Q4)</span>
                </button>
                <div id="import-tip" class="tooltip" role="tooltip">
                    Bulk import vehicle logs from CSV/XLSX template (max 100 rows)
                </div>
            </div>
        </section>

        <!-- Filter Bar -->
        <div class="filter-bar page-container">
            <div class="filter-group">
                <label>Saved Views:</label>
                <select id="savedViewsFilter">
                    <option value="all">All Logs</option>
                    <option value="my-pending">My Pending</option>
                    <option value="this-week">This Week</option>
                    <option value="over-budget">Over Budget</option>
                </select>
            </div>
            
            <div class="filter-separator"></div>
            
            <div class="filter-group">
                <label>Status:</label>
                <select id="statusFilter">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="draft">Draft</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Period:</label>
                <select id="periodFilter">
                    <option value="this-month">This Month</option>
                    <option value="last-month">Last Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Vehicle:</label>
                <select id="vehicleFilter">
                    <option value="all">All Vehicles</option>
                    <option value="B1234ABC">Honda Civic (B 1234 ABC)</option>
                    <option value="B5678DEF">Toyota Avanza (B 5678 DEF)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <input type="text" id="searchFilter" placeholder="Search destination...">
            </div>
            
            <div class="filter-group">
                <label>Sort:</label>
                <select id="sortFilter">
                    <option value="date-desc">Date (Newest)</option>
                    <option value="date-asc">Date (Oldest)</option>
                    <option value="distance-desc">Distance (High to Low)</option>
                    <option value="cost-desc">Cost (High to Low)</option>
                </select>
            </div>
        </div>

        <!-- Vehicle Logs -->
        <section class="vehicle-logs page-container">
            <div class="section-header">
                <h3>Vehicle Logs</h3>
                <span class="log-count">24 logs found</span>
            </div>
            
            <div class="log-list">
                <!-- Log Card 1 - Pending with Policy Violation -->
                <div class="log-card" data-log-id="VH-2025-0315-001">
                    <div class="log-header">
                        <div class="log-date">
                            <span class="date">15 Mar 2025</span>
                            <span class="vehicle">Honda Civic • B 1234 ABC</span>
                            <span class="linked-trip"><a href="travel.html#TRV-2025-0032">Linked trip: TRV-2025-0032</a></span>
                        </div>
                        <div class="log-status">
                            <span class="status-badge pending" aria-label="Status: Pending approval">Pending</span>
                            <span class="policy-chip violation" aria-label="Policy violation: Over budget limit">Over Budget</span>
                            <span class="sla-chip amber" aria-label="SLA status: Due in 2 days">Due in 2 days</span>
                        </div>
                    </div>
                    <div class="log-content">
                        <div class="log-details">
                            <div class="distance-info">
                                <span class="odometer-range">12,500 - 12,640 km → </span>
                                <span class="distance">140 km</span>
                            </div>
                            <div class="cost-breakdown">
                                <div class="cost-item">
                                    <div class="cost-label">Fuel</div>
                                    <div class="cost-detail">20L × Rp 15,000/L</div>
                                    <div class="cost-amount">Rp 300,000</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">Parking</div>
                                    <div class="cost-amount">Rp 10,000</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">Toll</div>
                                    <div class="cost-amount">Rp 5,000</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="log-actions footer-row">
                        <button class="btn-sm" onclick="viewLog('VH-2025-0315-001')">View</button>
                        <button class="btn-sm primary" onclick="editLog('VH-2025-0315-001')">Edit</button>
                        <button class="btn-sm success" onclick="exportToExpense('VH-2025-0315-001')" title="Export this pending log to expense draft">Export to Expense</button>
                    </div>
                </div>

                <!-- Log Card 2 - Approved -->
                <div class="log-card" data-log-id="VH-2025-0314-002">
                    <div class="log-header">
                        <div class="log-date">
                            <span class="date">14 Mar 2025</span>
                            <span class="vehicle">Toyota Avanza • B 5678 DEF</span>
                        </div>
                        <div class="log-status">
                            <span class="status-badge approved" aria-label="Status: Approved">Approved</span>
                            <span class="policy-chip ok" aria-label="Policy status: Compliant with policy">Policy OK</span>
                        </div>
                    </div>
                    <div class="log-content">
                        <div class="log-details">
                            <div class="distance-info">
                                <span class="odometer-range">8,200 - 8,285 km → </span>
                                <span class="distance">85 km</span>
                            </div>
                            <div class="cost-breakdown">
                                <div class="cost-item">
                                    <div class="cost-label">Fuel</div>
                                    <div class="cost-detail">12L × Rp 14,200/L</div>
                                    <div class="cost-amount">Rp 170,400</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">Parking</div>
                                    <div class="cost-amount">Rp 5,000</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">Toll</div>
                                    <div class="cost-amount">Rp 0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="log-actions footer-row">
                        <button class="btn-sm" onclick="viewLog('VH-2025-0314-002')">View</button>
                        <button class="btn-sm success" onclick="convertToExpense('VH-2025-0314-002')" title="Convert this log into an expense draft">Convert to expense</button>
                    </div>
                </div>

                <!-- Log Card 3 - Draft -->
                <div class="log-card" data-log-id="VH-2025-0313-003">
                    <div class="log-header">
                        <div class="log-date">
                            <span class="date">13 Mar 2025</span>
                            <span class="vehicle">Honda Civic • B 1234 ABC</span>
                        </div>
                        <div class="log-status">
                            <span class="status-badge draft" aria-label="Status: Draft - not yet submitted">Draft</span>
                            <span class="policy-chip warning" aria-label="Policy warning: Approaching soft cap limit">Soft Cap</span>
                        </div>
                    </div>
                    <div class="log-content">
                        <div class="log-details">
                            <div class="distance-info">
                                <span class="odometer-range">12,350 - 12,500 km → </span>
                                <span class="distance">150 km</span>
                            </div>
                            <div class="cost-breakdown">
                                <div class="cost-item">
                                    <div class="cost-label">Fuel</div>
                                    <div class="cost-detail">18L × Rp 14,800/L</div>
                                    <div class="cost-amount">Rp 266,400</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">Parking</div>
                                    <div class="cost-amount">Rp 15,000</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">Toll</div>
                                    <div class="cost-amount">Rp 10,000</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="log-actions footer-row">
                        <button class="btn-sm" onclick="viewLog('VH-2025-0313-003')">View</button>
                        <button class="btn-sm primary" onclick="submitLog('VH-2025-0313-003')">Submit for approval</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- New Log Chooser Modal -->
        <div id="newLogModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create new vehicle log</h3>
                    <button class="modal-close" onclick="closeModal('newLogModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="log-type-chooser">
                        <div class="log-type-card" onclick="openFuelMileageForm()">
                            <div class="type-icon">
                                <i class="fas fa-gas-pump"></i>
                            </div>
                            <h4>Fuel + Mileage</h4>
                            <p>Log fuel consumption and distance traveled</p>
                        </div>
                        <div class="log-type-card" onclick="openParkingTollForm()">
                            <div class="type-icon">
                                <i class="fas fa-parking"></i>
                            </div>
                            <h4>Parking/Toll only</h4>
                            <p>Record parking fees and toll charges</p>
                        </div>
                        <div class="log-type-card" onclick="openMaintenanceForm()">
                            <div class="type-icon">
                                <i class="fas fa-wrench"></i>
                            </div>
                            <h4>Maintenance</h4>
                            <p>Log vehicle maintenance expenses</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Empty State (hidden by default, shown when no results) -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-car"></i>
                </div>
                <h3 class="empty-title">No vehicle logs yet</h3>
                <p class="empty-subtitle">Try adjusting filters or create a new vehicle log</p>
                <button class="btn-sm primary" onclick="showNewLogChooser()">
                    <i class="fas fa-plus" style="margin-right: 8px;"></i>
                    Create vehicle log
                </button>
            </div>
        </div>

        <!-- New Vehicle Log Wizard Modal (3-step) -->
        <div id="fuelMileageModal" class="modal" style="display: none;">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>New vehicle log</h3>
                    <button class="modal-close" onclick="closeModal('fuelMileageModal')">&times;</button>
                </div>
                <div class="modal-body" style="padding-bottom: 0;">
                    <!-- Step Tabs -->
                    <div class="wizard-tabs" role="tablist" style="display: flex; gap: 8px; border-bottom: 1px solid #eee; margin: -14px -16px 12px; padding: 0 16px;">
                        <button type="button" class="wizard-tab" role="tab" data-step="0" aria-current="page" aria-selected="true" aria-controls="wizard-step-0">Basic</button>
                        <button type="button" class="wizard-tab" role="tab" data-step="1" aria-selected="false" aria-controls="wizard-step-1">Fuel</button>
                        <button type="button" class="wizard-tab" role="tab" data-step="2" aria-selected="false" aria-controls="wizard-step-2">Attachments</button>
                    </div>
                    <form id="fuelMileageForm" class="vehicle-form">
                        <!-- Step 0: Basic -->
                        <div class="wizard-step" role="tabpanel" id="wizard-step-0" data-step="0" aria-labelledby="wizard-tab-0">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="vehicleSelect">Vehicle <span class="req">*</span></label>
                                    <select id="vehicleSelect" required>
                                        <option value="">Select Vehicle</option>
                                        <option value="B1234ABC">B 1234 ABC - Honda Civic</option>
                                        <option value="B5678DEF">B 5678 DEF - Toyota Avanza</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="logDate">Date <span class="req">*</span></label>
                                    <input type="date" id="logDate" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="odoStart">Odometer Start (km) <span class="req">*</span></label>
                                    <input type="number" id="odoStart" placeholder="12,500" required>
                                    <small class="form-hint">Auto-prefilled from last record</small>
                                </div>
                                <div class="form-group">
                                    <label for="odoEnd">Odometer End (km) <span class="req">*</span></label>
                                    <input type="number" id="odoEnd" placeholder="12,640" required>
                                    <small class="form-hint">Distance will be calculated automatically</small>

                                    <!-- Policy helper banner (green / amber / red / neutral) -->
                                    <div id="rate-per-km" class="banner banner-neutral" role="status" aria-live="polite">
                                        <span id="rate-icon" class="icon"></span>
                                        <span id="rate-display">Enter fuel volume & price to calculate cost/km.</span>
                                        <div id="policy-caption"></div>
                                    </div>

                                    <!-- styles moved to global CSS -->
                                </div>
                            </div>
                        </div>
                        <!-- Step 1: Fuel -->
                        <div class="wizard-step" role="tabpanel" id="wizard-step-1" data-step="1" style="display:none;" aria-labelledby="wizard-tab-1">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fuelVolume">Fuel Volume (L) <span class="req">*</span></label>
                                    <input type="number" step="0.1" id="fuelVolume" placeholder="20.0" required>
                                </div>
                                <div class="form-group">
                                    <label for="pricePerL">Price per Liter (Rp) <span class="req">*</span></label>
                                    <input type="number" id="pricePerL" placeholder="14,000" required>
                                    <small class="form-hint policy-hint">Soft cap: Rp 14,500/L</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="parkingFee">Parking Fee (Rp)</label>
                                    <input type="number" id="parkingFee" placeholder="0">
                                    <small class="form-hint">Hard cap: Rp 100,000/day</small>
                                </div>
                                <div class="form-group">
                                    <label for="tollFee">Toll Fee (Rp)</label>
                                    <input type="number" id="tollFee" placeholder="0">
                                </div>
                            </div>
                            <!-- Policy helper banner mirrored in Step 1 (Fuel) -->
                            <div id="rate-per-km-step1" class="banner banner-neutral" role="status" aria-live="polite">
                                <span class="icon"></span>
                                <span class="rate-display">Enter fuel volume & price to calculate cost/km.</span>
                                <div class="policy-caption"></div>
                            </div>
                            <!-- styles moved to global CSS -->
                        </div>
                        <!-- Step 2: Attachments -->
                        <div class="wizard-step" role="tabpanel" id="wizard-step-2" data-step="2" style="display:none;" aria-labelledby="wizard-tab-2">
                            <div class="form-group">
                                <label for="receipt">Receipt</label>
                                <input type="file" id="receipt" accept=".jpg,.jpeg,.png,.pdf">
                                <small class="form-hint">Required if fuel > 10L. Max 5MB</small>
                            </div>
                            <div class="form-group">
                                <label for="odoPhoto">Odometer photo</label>
                                <input type="file" id="odoPhoto" accept="image/*" capture="environment">
                                <small class="form-hint">Required when distance ≥ 100 km</small>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="autoSyncGPS">
                                    <span class="checkmark"></span>
                                    Auto-sync GPS location
                                </label>
                            </div>
                            <!-- Policy Panel -->
                            <div class="policy-panel">
                                <h4>Policy check</h4>
                                <div class="policy-indicators">
                                    <div class="policy-item ok">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Fuel efficiency within normal range</span>
                                    </div>
                                    <div class="policy-item warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Price per liter approaching soft cap</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Wizard Navigation -->
                        <div class="modal-footer">
                            <div>
                                <button type="button" class="btn btn-ghost" id="wizardBackBtn" onclick="wizardPrev()" disabled>Back</button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-ghost" onclick="saveDraft()">Save draft</button>
                                <button type="button" class="btn primary" id="wizardNextBtn" onclick="wizardNext()">Next</button>
                                <button type="submit" class="btn primary" id="wizardSubmitBtn" style="display:none;">Submit for approval</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="mwp.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>MWP</span>
        </a>
        <a href="travel.html" class="nav-item">
            <i class="fas fa-plane"></i>
            <span>Travel</span>
        </a>
        <a href="vehicle.html" class="nav-item active" aria-current="page">
            <i class="fas fa-car"></i>
            <span>Vehicle</span>
            <span class="nav-badge warning" id="badge-vehicle" data-count="1" title="1 policy violation">1</span>
        </a>
        <a href="cash-advance.html" class="nav-item">
            <i class="fas fa-money-bill-wave"></i>
            <span>Advances</span>
            <span class="nav-badge" id="badge-advances" data-count="2" title="2 outstanding advances">2</span>
        </a>
        <a href="expenses.html" class="nav-item">
            <i class="fas fa-receipt"></i>
            <span>Expenses</span>
            <span class="nav-badge warning" id="badge-expenses" data-count="3" title="3 violations found">3</span>
        </a>
        <a href="approvals.html" class="nav-item">
            <i class="fas fa-check-circle"></i>
            <span>Approvals</span>
            <span class="nav-badge" id="badge-approvals" data-count="5" title="5 approvals pending">5</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- FAB for New Vehicle Log -->
    <button class="fab" onclick="showNewLogChooser()" title="New vehicle log" aria-label="Create new vehicle log">
        <i class="fas fa-plus"></i>
    </button>

    <script src="script.js"></script>
    <script>
        // Vehicle Module Functions
        function showNewLogChooser() {
            document.getElementById('newLogModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openFuelMileageForm() {
            closeModal('newLogModal');
            document.getElementById('fuelMileageModal').style.display = 'flex';
            // Set today's date as default
            document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
            // Initialize wizard to first step
            setWizardStep(0);
        }

        function openParkingTollForm() {
            showNotImplementedPopup('Parking/Toll Form');
        }

        function openMaintenanceForm() {
            showNotImplementedPopup('Maintenance Form');
        }

        function showImportDialog() {
            showNotImplementedPopup('Import to Expense');
        }

        function viewLog(logId) {
            showNotImplementedPopup(`View Log ${logId}`);
        }

        function editLog(logId) {
            showNotImplementedPopup(`Edit Log ${logId}`);
        }

        function submitLog(logId) {
            if (confirm(`Submit log ${logId} for approval?`)) {
                showNotImplementedPopup(`Submit Log ${logId}`);
            }
        }

        function convertToExpense(logId) {
            if (confirm(`Convert log ${logId} into an expense draft?`)) {
                const expenseId = `EXP-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 9999)).padStart(4, '0')}`;
                showSnackbar(`Vehicle log ${logId} converted to draft ${expenseId}`);
            }
        }

        function exportToExpense(logId) {
            if (confirm(`Export pending log ${logId} to expense draft?`)) {
                const expenseId = `EXP-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 9999)).padStart(4, '0')}`;
                showSnackbar(`Pending log ${logId} exported to expense draft ${expenseId}`);
                
                // Update the log card to show expense-draft status
                const logCard = document.querySelector(`[data-log-id="${logId}"]`);
                if (logCard) {
                    const statusContainer = logCard.querySelector('.log-status');
                    const expenseChip = document.createElement('span');
                    expenseChip.className = 'policy-chip ok';
                    expenseChip.setAttribute('aria-label', 'Status: Exported to expense draft');
                    expenseChip.textContent = 'Expense Draft';
                    statusContainer.appendChild(expenseChip);
                }
            }
        }

        // Simple wizard state
        let wizardStep = 0;
        function setWizardStep(step) {
            wizardStep = step;
            // Tabs with proper ARIA attributes
            document.querySelectorAll('.wizard-tab').forEach((tab, index) => {
                const s = parseInt(tab.dataset.step, 10);
                const isActive = s === step;
                tab.setAttribute('aria-current', isActive ? 'page' : 'false');
                tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                tab.setAttribute('id', `wizard-tab-${s}`);
                tab.style.color = isActive ? '#4f46e5' : '#64748b';
                tab.style.fontWeight = isActive ? '600' : '500';
                tab.style.borderBottom = isActive ? '2px solid #4f46e5' : '2px solid transparent';
            });
            // Steps
            document.querySelectorAll('.wizard-step').forEach(p => {
                const stepNum = parseInt(p.dataset.step, 10);
                p.style.display = stepNum === step ? 'block' : 'none';
                p.setAttribute('aria-hidden', stepNum === step ? 'false' : 'true');
            });
            // Buttons
            const back = document.getElementById('wizardBackBtn');
            const next = document.getElementById('wizardNextBtn');
            const submit = document.getElementById('wizardSubmitBtn');
            back.disabled = step === 0;
            next.style.display = step < 2 ? 'inline-flex' : 'none';
            submit.style.display = step === 2 ? 'inline-flex' : 'none';
        }
        function wizardNext() {
            if (!validateWizardStep(wizardStep)) return;
            setWizardStep(Math.min(2, wizardStep + 1));
        }
        function wizardPrev() {
            setWizardStep(Math.max(0, wizardStep - 1));
        }
        function validateWizardStep(step) {
            // Minimal per-step validation to unblock QA
            if (step === 0) {
                const vehicle = document.getElementById('vehicleSelect').value;
                const date = document.getElementById('logDate').value;
                const start = document.getElementById('odoStart').value;
                const end = document.getElementById('odoEnd').value;
                if (!vehicle || !date || !start || !end || Number(end) - Number(start) <= 0) {
                    alert('Please fill vehicle, date, and valid odometer values.');
                    return false;
                }
                return true;
            }
            if (step === 1) {
                const vol = parseFloat(document.getElementById('fuelVolume').value);
                const price = parseFloat(document.getElementById('pricePerL').value);
                if (!(vol > 0) || !(price > 0)) {
                    alert('Please input fuel volume and price per liter.');
                    return false;
                }
                return true;
            }
            return true;
        }

        // Show snackbar notification
        function showSnackbar(message) {
            const snackbar = document.createElement('div');
            snackbar.style.cssText = `
                position: fixed;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%);
                background: #323232;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                font-size: 14px;
                z-index: 10000;
                animation: slideUp 0.3s ease;
            `;
            
            // Add CSS animation if not already added
            if (!document.querySelector('#snackbar-animation-style')) {
                const style = document.createElement('style');
                style.id = 'snackbar-animation-style';
                style.textContent = `
                    @keyframes slideUp {
                        from {
                            transform: translateX(-50%) translateY(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(-50%) translateY(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            snackbar.style.cssText = `
                position: fixed;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%);
                background: #323232;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                font-size: 14px;
                z-index: 10000;
                animation: slideUp 0.3s ease;
            `;
            snackbar.textContent = message;
            document.body.appendChild(snackbar);
            
            setTimeout(() => {
                snackbar.remove();
            }, 4000);
        }

        function saveDraft() {
            showNotImplementedPopup('Save Draft');
        }

        // Form validation and policy checking
        function validateFuelMileageForm() {
            const form = document.getElementById('fuelMileageForm');
            const formData = new FormData(form);
            
            // Policy checks
            const pricePerL = parseFloat(document.getElementById('pricePerL').value);
            const parkingFee = parseFloat(document.getElementById('parkingFee').value) || 0;
            const fuelVolume = parseFloat(document.getElementById('fuelVolume').value);
            
            let policyViolations = [];
            
            // Fuel price soft cap check
            if (pricePerL > 14500) {
                policyViolations.push('Fuel price exceeds soft cap (Rp 14,500/L)');
            }
            
            // Parking hard cap check
            if (parkingFee > 100000) {
                alert('Parking fee exceeds hard cap (Rp 100,000/day). Please adjust.');
                return false;
            }
            
            // Receipt requirement check
            const receipt = document.getElementById('receipt').files[0];
            if (fuelVolume > 10 && !receipt) {
                alert('Receipt is required for fuel volume > 10L');
                return false;
            }

            // Hard-cap: Rp 1,600/km based on distance
            const startKm = parseFloat(document.getElementById('odoStart').value) || 0;
            const endKm = parseFloat(document.getElementById('odoEnd').value) || 0;
            const distance = endKm - startKm;
            const fuelCost = (fuelVolume > 0 && pricePerL > 0) ? (fuelVolume * pricePerL) : 0;
            if (distance > 0 && fuelCost > 0) {
                const ratePerKm = fuelCost / distance;
                if (ratePerKm > 1600) {
                    alert('Rate per km exceeds hard cap (Rp 1,600/km). Please adjust inputs.');
                    return false;
                }
            }

            // Require odometer photo when distance ≥ 100 km
            const odoPhoto = document.getElementById('odoPhoto')?.files?.[0];
            if (distance >= 100 && !odoPhoto) {
                alert('Odometer photo is required when distance is ≥ 100 km.');
                return false;
            }
            
            return true;
        }

        // Calculate distance when odometer values change
        function calculateDistance() {
            const startKm = parseFloat(document.getElementById('odoStart').value) || 0;
            const endKm = parseFloat(document.getElementById('odoEnd').value) || 0;
            const distance = endKm - startKm;
            
            if (distance > 0) {
                calculateRatePerKm(distance);
            } else {
                hideRatePerKm();
            }
        }
        
        // Calculate rate per km and show policy states (green/amber/red + neutral)
        function calculateRatePerKm(distance) {
            const fuelVolume = parseFloat(document.getElementById('fuelVolume').value) || 0;
            const pricePerL = parseFloat(document.getElementById('pricePerL').value) || 0;

            // Step 0 elements
            const rateWrap0 = document.getElementById('rate-per-km');
            const rateDisplay0 = document.getElementById('rate-display');
            const policyCaption0 = document.getElementById('policy-caption');

            // Step 1 mirrored elements
            const rateWrap1 = document.getElementById('rate-per-km-step1');
            const rateDisplay1 = rateWrap1?.querySelector('.rate-display');
            const policyCaption1 = rateWrap1?.querySelector('.policy-caption');

            // Helper to update a banner set
            const updateBanner = (wrap, displayEl, captionEl, state, formattedRate) => {
                if (!wrap) return;
                // Ensure visible when we have distance
                wrap.style.display = distance > 0 ? 'block' : 'none';
                wrap.classList.remove('banner-ok','banner-amber','banner-red','banner-neutral');
                wrap.classList.add('banner', state);
                if (displayEl) {
                    if (formattedRate) {
                        displayEl.textContent = `Rate: ${formattedRate}/km`;
                    } else {
                        displayEl.textContent = 'Enter fuel volume & price to calculate cost/km.';
                    }
                }
                if (captionEl) {
                    captionEl.textContent = (
                        state === 'banner-ok' ? 'Within policy' :
                        state === 'banner-amber' ? 'Approaching soft cap' :
                        state === 'banner-red' ? 'Exceeds soft cap' : ''
                    );
                }
            };

            if (!(distance > 0)) {
                // Hide both when distance invalid
                hideRatePerKm();
                if (rateWrap1) {
                    rateWrap1.style.display = 'none';
                    rateWrap1.classList.remove('banner-ok','banner-amber','banner-red');
                    rateWrap1.classList.add('banner-neutral');
                    if (policyCaption1) policyCaption1.textContent = '';
                }
                return;
            }

            const fuelCost = (fuelVolume > 0 && pricePerL > 0) ? (fuelVolume * pricePerL) : 0;

            // Thresholds
            const OK_MAX = 1200;
            const AMBER_MAX = 1500;

            if (fuelCost <= 0) {
                // Incomplete inputs -> neutral on both
                updateBanner(rateWrap0, rateDisplay0, policyCaption0, 'banner-neutral', null);
                updateBanner(rateWrap1, rateDisplay1, policyCaption1, 'banner-neutral', null);
                return;
            }

            const ratePerKm = fuelCost / distance;
            const formattedRate = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(ratePerKm);

            if (ratePerKm <= OK_MAX) {
                updateBanner(rateWrap0, rateDisplay0, policyCaption0, 'banner-ok', formattedRate);
                updateBanner(rateWrap1, rateDisplay1, policyCaption1, 'banner-ok', formattedRate);
            } else if (ratePerKm <= AMBER_MAX) {
                updateBanner(rateWrap0, rateDisplay0, policyCaption0, 'banner-amber', formattedRate);
                updateBanner(rateWrap1, rateDisplay1, policyCaption1, 'banner-amber', formattedRate);
            } else {
                updateBanner(rateWrap0, rateDisplay0, policyCaption0, 'banner-red', formattedRate);
                updateBanner(rateWrap1, rateDisplay1, policyCaption1, 'banner-red', formattedRate);
            }
        }

        function hideRatePerKm() {
            const rateWrap0 = document.getElementById('rate-per-km');
            const policyCaption0 = document.getElementById('policy-caption');
            if (rateWrap0) {
                rateWrap0.style.display = 'none';
                rateWrap0.classList.remove('banner-ok','banner-amber','banner-red');
                rateWrap0.classList.add('banner-neutral');
            }
            if (policyCaption0) policyCaption0.textContent = '';

            // Also hide Step 1 mirrored banner
            const rateWrap1 = document.getElementById('rate-per-km-step1');
            const policyCaption1 = rateWrap1?.querySelector('.policy-caption');
            if (rateWrap1) {
                rateWrap1.style.display = 'none';
                rateWrap1.classList.remove('banner-ok','banner-amber','banner-red');
                rateWrap1.classList.add('banner-neutral');
            }
            if (policyCaption1) policyCaption1.textContent = '';
        }

        // Auto-calculate distance
        document.getElementById('odoStart').addEventListener('input', calculateDistance);
        document.getElementById('odoEnd').addEventListener('input', calculateDistance);
        document.getElementById('fuelVolume').addEventListener('input', function() {
            const start = parseFloat(document.getElementById('odoStart').value) || 0;
            const end = parseFloat(document.getElementById('odoEnd').value) || 0;
            if (end > start) {
                calculateRatePerKm(end - start);
            } else {
                hideRatePerKm();
            }
        });
        document.getElementById('pricePerL').addEventListener('input', function() {
            const start = parseFloat(document.getElementById('odoStart').value) || 0;
            const end = parseFloat(document.getElementById('odoEnd').value) || 0;
            if (end > start) {
                calculateRatePerKm(end - start);
            } else {
                hideRatePerKm();
            }
        });

        // Form submission
       document.getElementById('fuelMileageForm').addEventListener('submit', function(e) {
           e.preventDefault();
           if (validateFuelMileageForm()) {
               showSnackbar('Vehicle log created • pending submission review');
               closeModal('fuelMileageModal');
           }
       });

        // Filter and sort event listeners
        document.getElementById('savedViewsFilter').addEventListener('change', function() {
            console.log('Saved views filter changed:', this.value);
            applySavedView(this.value);
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            console.log('Status filter changed:', this.value);
            applyFilters();
        });

        document.getElementById('periodFilter').addEventListener('change', function() {
            console.log('Period filter changed:', this.value);
            applyFilters();
        });

        document.getElementById('vehicleFilter').addEventListener('change', function() {
            console.log('Vehicle filter changed:', this.value);
            applyFilters();
        });

        document.getElementById('searchFilter').addEventListener('input', function() {
            console.log('Search filter changed:', this.value);
            applyFilters();
        });

        document.getElementById('sortFilter').addEventListener('change', function() {
            console.log('Sort changed:', this.value);
            applyFilters();
        });

        function applySavedView(view) {
            const logCards = document.querySelectorAll('.log-card');
            const emptyState = document.getElementById('emptyState');
            let visibleCount = 0;

            logCards.forEach(card => {
                let shouldShow = true;
                
                switch(view) {
                    case 'my-pending':
                        shouldShow = card.querySelector('.status-badge.pending') !== null;
                        break;
                    case 'this-week':
                        // Simple demo - show all for now
                        shouldShow = true;
                        break;
                    case 'over-budget':
                        shouldShow = card.querySelector('.policy-chip.violation') !== null;
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                        break;
                }
                
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });

            // Show/hide empty state
            emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
            
            // Update log count if element exists
             const logCountElement = document.querySelector('.log-count');
             if (logCountElement) {
                 logCountElement.textContent = `${visibleCount} logs found`;
             }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const vehicleFilter = document.getElementById('vehicleFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const logCards = document.querySelectorAll('.log-card');
            const emptyState = document.getElementById('emptyState');
            let visibleCount = 0;

            logCards.forEach(card => {
                let shouldShow = true;
                
                // Status filter
                if (statusFilter !== 'all') {
                    const statusBadge = card.querySelector('.status-badge');
                    if (!statusBadge || !statusBadge.classList.contains(statusFilter)) {
                        shouldShow = false;
                    }
                }
                
                // Vehicle filter
                if (vehicleFilter !== 'all' && shouldShow) {
                    const vehicleText = card.querySelector('.vehicle').textContent;
                    if (!vehicleText.includes(vehicleFilter)) {
                        shouldShow = false;
                    }
                }
                
                // Search filter
                if (searchFilter && shouldShow) {
                    const cardText = card.textContent.toLowerCase();
                    if (!cardText.includes(searchFilter)) {
                        shouldShow = false;
                    }
                }
                
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });

            // Show/hide empty state
            emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const visibleModals = document.querySelectorAll('.modal[style*="flex"]');
                visibleModals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Update user info
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                document.querySelector('.user-info span').textContent = `Hello, ${userEmail.split('@')[0]}`;
            }

            // KPI count-up (unified) with accessibility announcements
            const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
            function animateNumber(el, to, formatText) {
                const start = performance.now();
                const dur = 900;
                function tick(now) {
                    const p = Math.min(1, (now - start) / dur);
                    const val = Math.round(to * easeOutCubic(p));
                    el.textContent = formatText ? formatText(val) : String(val);
                    if (p < 1) requestAnimationFrame(tick);
                    else {
                        // Announce completion to screen readers
                        const liveRegion = document.getElementById('kpi-updates');
                        if (liveRegion) {
                            const label = el.closest('.kpi-card')?.querySelector('.kpi-label')?.textContent || 'KPI';
                            liveRegion.textContent = `${label} updated to ${el.textContent}`;
                        }
                    }
                }
                requestAnimationFrame(tick);
            }
            document.querySelectorAll('.kpi-number').forEach(el => {
                const countText = el.getAttribute('data-count-text');
                const count = el.getAttribute('data-count');
                if (countText) {
                    // currency or formatted text — just snap after short delay to avoid layout shift
                    setTimeout(() => {
                        el.textContent = countText;
                        // Announce to screen readers
                        const liveRegion = document.getElementById('kpi-updates');
                        if (liveRegion) {
                            const label = el.closest('.kpi-card')?.querySelector('.kpi-label')?.textContent || 'KPI';
                            liveRegion.textContent = `${label} updated to ${countText}`;
                        }
                    }, 350);
                } else if (count) {
                    const to = parseInt(count, 10) || 0;
                    animateNumber(el, to);
                }
            });

            // Footer-row behavior: sticky on mobile, hover show on desktop
            const mq = window.matchMedia('(min-width: 1025px)');
            const applyFooter = () => {
                document.querySelectorAll('.log-card').forEach(card => {
                    const footer = card.querySelector('.footer-row') || card.querySelector('.log-actions.footer-row');
                    if (!footer) return;
                    if (mq.matches) {
                        // Desktop: hidden by default, show thin footer bar on hover
                        footer.style.display = 'none';
                        card.onmouseenter = () => {
                            footer.style.display = 'flex';
                            footer.style.borderTop = '1px solid #f0f0f0';
                            footer.style.paddingTop = '8px';
                            footer.style.marginTop = '8px';
                        };
                        card.onmouseleave = () => {
                            footer.style.display = 'none';
                        };
                        footer.style.position = '';
                        footer.style.bottom = '';
                        footer.style.background = '';
                        footer.style.paddingBottom = '';
                    } else {
                        // Mobile: sticky footer visible
                        card.onmouseenter = null;
                        card.onmouseleave = null;
                        footer.style.display = 'flex';
                        footer.style.position = 'sticky';
                        footer.style.bottom = '0';
                        footer.style.background = '#fff';
                        footer.style.paddingBottom = '8px';
                        // Prevent overlap by ensuring min padding bottom on card
                        card.style.paddingBottom = '56px';
                    }
                });
            };
            applyFooter();
            mq.addEventListener?.('change', applyFooter);

            // Numeric alignment guard
            document.querySelectorAll('.cost-breakdown div div:last-child').forEach(el => {
                el.classList.add('numeric');
                el.style.textAlign = 'right';
            });

            // Deep link: open chooser or wizard directly
            if (location.hash === '#new-log') {
                showNewLogChooser();
                // optional: jump straight to wizard fuel+mileage
                setTimeout(() => {
                    if (document.getElementById('newLogModal').style.display === 'flex') {
                        openFuelMileageForm();
                    }
                }, 200);
            }

            // No-op: gutters handled by CSS classes (page-container)
        });

        // Initialize page (duplicate cleanup consolidated above)
    </script>
    <script>
        // Toggle user menu
        function toggleUserMenu() {
            // Placeholder for user menu functionality
            // In a real app, this would show/hide a dropdown menu
            console.log('User menu toggled');
            alert('User menu - Coming soon!');
        }
    </script>
</body>
</html>
