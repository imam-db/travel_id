<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrevID - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3d0974">
    <link rel="icon" href="/assets/brand/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/brand/trevid_icon_192.png">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img 
                    class="brand-logo" 
                    src="assets/brand/trevid_logo.png" 
                    srcset="/assets/brand/trevid_logo.png 1x, /assets/brand/trevid_logo@2x.png 2x" 
                    alt="TrevID – Business Companion" 
                    width="140" height="36" />
            </div>
            <div class="quick-actions-desktop">
                <button class="action-btn" onclick="showNotImplementedPopup('Add Expense')" aria-label="Add new expense"><i class="fas fa-plus"></i> Add Expense</button>
                <button class="action-btn" onclick="window.location.href='travel-new.html'" aria-label="Create new trip"><i class="fas fa-plane"></i> New Trip</button>
                <button class="action-btn" onclick="window.location.href='cash-advance.html'" aria-label="Request cash advance"><i class="fas fa-money-bill"></i> Request Advance</button>
                <button class="action-btn" onclick="window.location.href='vehicle.html#new-log'" aria-label="Log vehicle mileage"><i class="fas fa-road"></i> Log Mileage</button>
            </div>
            <div class="user-info">
                <span>Hello, John Doe</span>
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item active" aria-current="page">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="mwp.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>MWP</span>
        </a>
        <a href="travel.html" class="nav-item">
            <i class="fas fa-plane"></i>
            <span>Travel</span>
        </a>
        <a href="vehicle.html" class="nav-item">
            <i class="fas fa-car"></i>
            <span>Vehicle</span>
            <span class="nav-badge warning" id="badge-vehicle" data-count="3" title="3 pending/policy issues">3</span>
        </a>
        <a href="expenses.html" class="nav-item">
            <i class="fas fa-receipt"></i>
            <span>Expenses</span>
            <span class="nav-badge warning" id="badge-expenses" data-count="3" title="3 violations found">3</span>
        </a>
        <a href="approvals.html" class="nav-item">
            <i class="fas fa-check-circle"></i>
            <span>Approvals</span>
            <span class="nav-badge" id="badge-approvals" data-count="5" title="5 approvals pending">5</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
        <a href="admin.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Admin</span>
        </a>
    </nav>

    <!-- Toast Container for Accessibility -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h1>Welcome!</h1>
                <p>Manage your business travel and expenses with ease</p>
            </section>

            <!-- Global Filter -->
            <section class="global-filter">
                <div class="filter-controls">
                    <div class="period-picker">
                        <label for="dateRange" class="sr-only">Date range</label>
                        <select class="filter-select" id="dateRange">
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="last_3_months">Last 3 Months</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div class="custom-period" id="customPeriod" style="display: none;">
                            <input type="date" class="date-picker" id="startDate" aria-label="Start date">
                            <span>to</span>
                            <input type="date" class="date-picker" id="endDate" aria-label="End date">
                        </div>
                    </div>
                    <button class="filter-toggle" id="currencyToggle" onclick="toggleCurrency()" aria-pressed="false" aria-label="Switch currency to IDR">
                        <i class="fas fa-exchange-alt"></i> USD
                    </button>
                </div>
            </section>

            <!-- Compact Announcement Banner -->
            <section class="announcement-banner">
                <div class="banner-content">
                    <i class="fas fa-bullhorn"></i>
                    <span>System updates this weekend • Submit expense reports before Friday</span>
                    <a href="announcements.html" class="banner-link">View all</a>
                </div>
            </section>

            <!-- My Tasks Widget (Priority 1) -->
            <section class="my-tasks-section">
                <div class="dashboard-card tasks-card">
                    <div class="card-header">
                        <h3><i class="fas fa-tasks"></i> Pending Tasks</h3>
                        <span class="tasks-count">4 pending</span>
                    </div>
                    <div class="card-content">
                        <div class="task-chips">
                            <button class="task-chip" onclick="window.location.href='receipts.html?filter=missing'" aria-label="View missing receipts">
                                <i class="fas fa-receipt"></i>
                                <span class="task-label">Missing receipts</span>
                                <span class="task-count">2</span>
                            </button>
                            <button class="task-chip" onclick="window.location.href='expenses.html?filter=draft'" aria-label="View draft reports">
                                <i class="fas fa-file-alt"></i>
                                <span class="task-label">Draft reports</span>
                                <span class="task-count">2</span>
                            </button>
                            <button class="task-chip" onclick="showNotImplementedPopup('Trips to Expense')" aria-label="View trips to expense">
                                <i class="fas fa-plane"></i>
                                <span class="task-label">Trips to expense</span>
                                <span class="task-count">1</span>
                            </button>
                            <button class="task-chip" onclick="window.location.href='cash-advance.html?filter=settle'" aria-label="View advances to settle">
                                <i class="fas fa-money-bill"></i>
                                <span class="task-label">Advances to settle</span>
                                <span class="task-count">1</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>



            <!-- Quick Stats for Main Menus -->
            <section class="quick-stats">
                <div class="summary-grid">
                    <a href="mwp.html" class="dashboard-card stat-card mwp-stat">
                        <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                        <div class="stat-info">
                            <span class="stat-title">MWP</span>
                            <span class="stat-value">3 drafts</span>
                        </div>
                    </a>
                    <a href="travel.html" class="dashboard-card stat-card travel-stat">
                        <div class="stat-icon"><i class="fas fa-plane"></i></div>
                        <div class="stat-info">
                            <span class="stat-title">Travel</span>
                            <span class="stat-value">1 upcoming</span>
                        </div>
                    </a>
                    <a href="vehicle.html" class="dashboard-card stat-card vehicle-stat">
                        <div class="stat-icon"><i class="fas fa-car"></i></div>
                        <div class="stat-info">
                            <span class="stat-title">Vehicle</span>
                            <span class="stat-value">3 pending</span>
                        </div>
                    </a>
                    <a href="expenses.html" class="dashboard-card stat-card expense-stat">
                        <div class="stat-icon"><i class="fas fa-receipt"></i></div>
                        <div class="stat-info">
                            <span class="stat-title">Expenses</span>
                            <span class="stat-value">2 drafts</span>
                        </div>
                    </a>
                    <a href="approvals.html" class="dashboard-card stat-card approval-stat">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-info">
                            <span class="stat-title">Approvals</span>
                            <span class="stat-value">5 pending</span>
                        </div>
                    </a>
                </div>
            </section>

            <!-- Row 1: Hero Cards -->
            <section class="hero-row">
                <div class="card-grid">
                    <!-- Your Approvals -->
                    <div class="dashboard-card approvals-card" tabindex="0" onclick="window.location.href='approvals.html'" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.location.href='approvals.html';}">
                        <div class="card-header">
                            <h3><i class="fas fa-check-circle"></i> Your Approvals</h3>
                            <span class="badge pending-badge">3</span>
                        </div>
                        <div class="card-content">
                            <div class="approval-stats">
                                <span class="stat-item">Pending <strong>3</strong></span>
                                <span class="stat-divider">•</span>
                                <span class="stat-item over-sla">Over SLA <strong>1</strong></span>
                                <span class="stat-divider">•</span>
                                <span class="stat-item">Avg <strong>1.2d</strong></span>
                            </div>
                            <button class="cta-button primary">Review now</button>
                        </div>
                    </div>
    
                    <!-- My Reports -->
                    <div class="dashboard-card reports-card" tabindex="0" onclick="window.location.href='expenses.html'" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.location.href='expenses.html';}">
                        <div class="card-header">
                            <h3><i class="fas fa-file-alt"></i> My Reports</h3>
                        </div>
                        <div class="card-content">
                            <div class="report-stats">
                                <span class="stat-item">Draft <strong>2</strong></span>
                                <span class="stat-divider">•</span>
                                <span class="stat-item">Submitted <strong>1</strong></span>
                                <span class="stat-divider">•</span>
                                <span class="stat-item">Approved <strong>0</strong></span>
                                <span class="stat-divider">•</span>
                                <span class="stat-item">Paid <strong>1</strong></span>
                            </div>
                            <button class="cta-button secondary" onclick="event.stopPropagation(); showNotImplementedPopup('New Report')">New report</button>
                        </div>
                    </div>
    
                </div>
            </section>

            <!-- Row 2: Budget & Cash Advance -->
            <section class="budget-row">
                <div class="card-grid">
                    <!-- Monthly Budget -->
                    <div class="dashboard-card budget-card">
                        <div class="card-header">
                            <h3><i class="fas fa-wallet"></i> Monthly Budget</h3>
                            <span class="budget-status warning">85% used</span>
                        </div>
                        <div class="card-content">
                            <div class="budget-overview">
                                <div class="budget-amount">
                                    <span class="used">$4,250</span>
                                    <span class="total">of $5,000</span>
                                </div>
                                <div class="budget-breakdown">
                                    <div class="breakdown-bar">
                                        <div class="bar-segment meals" style="width: 30%" title="Meals: $1,275"></div>
                                        <div class="bar-segment travel" style="width: 25%" title="Travel: $1,063"></div>
                                        <div class="bar-segment hotel" style="width: 35%" title="Hotel: $1,488"></div>
                                        <div class="bar-segment others" style="width: 10%" title="Others: $425"></div>
                                    </div>
                                    <div class="breakdown-legend">
                                        <span class="legend-item"><span class="color-dot meals"></span>Meals</span>
                                        <span class="legend-item"><span class="color-dot travel"></span>Travel</span>
                                        <span class="legend-item"><span class="color-dot hotel"></span>Hotel</span>
                                        <span class="legend-item"><span class="color-dot others"></span>Others</span>
                                    </div>
                                </div>
                            </div>
                            <button class="cta-button secondary" onclick="showNotImplementedPopup('View Budget Breakdown')">View breakdown</button>
                        </div>
                    </div>

                    <!-- Cash Advance & Policy Alerts -->
                    <div class="side-cards">
                        <div class="dashboard-card cash-advance-card">
                            <div class="card-header">
                                <h3><i class="fas fa-money-bill-wave"></i> Cash Advance</h3>
                            </div>
                            <div class="card-content">
                                <div class="cash-summary">
                                    <span class="outstanding" onclick="showNotImplementedPopup('Outstanding Advances')" style="cursor: pointer;">Outstanding $2,000</span>
                                    <span class="stat-divider">•</span>
                                    <span class="pending" onclick="showNotImplementedPopup('Pending Approvals')" style="cursor: pointer;">Pending approvals 1</span>
                                </div>
                                <button class="cta-button primary" onclick="window.location.href='cash-advance.html'">Request advance</button>
                            </div>
                        </div>

                        <div class="dashboard-card policy-alerts-card">
                            <div class="card-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Policy Alerts</h3>
                            </div>
                            <div class="card-content">
                                <div class="alert-stats">
                                    <span class="alert-item" onclick="showNotImplementedPopup('Missing Receipt Details')" style="cursor: pointer;">Missing receipt <strong>2</strong></span>
                                    <span class="alert-item" onclick="showNotImplementedPopup('Per Diem Details')" style="cursor: pointer;">Over per diem <strong>1</strong></span>
                                    <span class="alert-item" onclick="showNotImplementedPopup('Budget Details')" style="cursor: pointer;">Over budget <strong>1</strong></span>
                                </div>
                            </div>
                        </div>
                        <a href="#" class="view-all-activities" onclick="showNotImplementedPopup('View All Activities')">View all activities</a>
                    </div>
                </div>
            </section>

            <!-- Row 3: Calendar/Agenda (Combined MWP + Schedule) -->
            <section class="agenda-row">
                <div class="card-grid agenda-grid">
                    <!-- Calendar/Agenda Widget -->
                    <div class="dashboard-card agenda-card">
                        <div class="card-header">
                            <h3><i class="fas fa-calendar-alt"></i> Calendar & Agenda</h3>
                            <div class="agenda-actions">
                                <button class="view-toggle" id="agendaViewToggle" onclick="toggleAgendaView()" title="Switch to calendar view" aria-label="Switch to calendar view">
                                    <i class="fas fa-calendar"></i> Calendar view
                                </button>
                                <a href="mwp.html" class="view-all-link">View all MWP</a>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="agenda-timeline">
                                <!-- Today & This Week -->
                                <div class="timeline-section">
                                    <h4 class="timeline-header">This Week</h4>
                                    <div class="timeline-item">
                                        <div class="timeline-dot travel"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">Mon 13</span>
                                            <span class="timeline-event">
                                                <i class="fas fa-plane"></i> Jakarta Trip Start • 10:00 AM
                                            </span>
                                            <button class="timeline-cta" onclick="showNotImplementedPopup('Open Trip Details')">
                                                Open trip
                                            </button>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-dot receipt"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">Wed 15</span>
                                            <span class="timeline-event">
                                                <i class="fas fa-receipt"></i> Receipt deadline • Bandung expenses
                                            </span>
                                            <button class="timeline-cta" onclick="window.location.href='receipts.html?filter=missing'">
                                                Upload receipt
                                            </button>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-dot report"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">Fri 17</span>
                                            <span class="timeline-event">
                                                <i class="fas fa-file-alt"></i> Report submission due • Q1 expenses
                                            </span>
                                            <button class="timeline-cta" onclick="window.location.href='expenses.html?filter=draft'">
                                                Open report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Upcoming Trips from MWP -->
                                <div class="timeline-section">
                                    <h4 class="timeline-header">Upcoming Trips</h4>
                                    <div class="timeline-item">
                                        <div class="timeline-dot approved"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">May 13-15</span>
                                            <span class="timeline-event">
                                                <i class="fas fa-plane"></i> CGK-BDO Bandung • Est. $2,500
                                                <span class="policy-flag warning" title="Over budget meal: $15 exceeded">Budget meal</span>
                                            </span>
                                            <button class="timeline-cta" onclick="convertSingleTrip('trip-bandung-001')">
                                                Convert to Travel
                                            </button>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-dot pending"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">May 20-22</span>
                                            <span class="timeline-event">
                                                <i class="fas fa-plane"></i> BDO-CGK Jakarta • Est. $1,800
                                            </span>
                                            <span class="timeline-status pending">Pending approval</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Advance Repayments -->
                                <div class="timeline-section">
                                    <h4 class="timeline-header">Advance Repayments</h4>
                                    <div class="timeline-item">
                                        <div class="timeline-dot money"></div>
                                        <div class="timeline-content">
                                            <span class="timeline-date">May 30</span>
                                            <span class="timeline-event">
                                                <i class="fas fa-money-bill"></i> Advance repayment due • $2,000
                                            </span>
                                            <button class="timeline-cta" onclick="window.location.href='cash-advance.html?filter=settle'">
                                                Settle advance
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Calendar View (Hidden by default) -->
                            <div class="agenda-calendar" style="display: none;">
                                <div class="calendar-header">
                                    <button class="btn-ghost calendar-nav" id="prevMonth" aria-label="Previous month">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h4 class="calendar-month" id="currentMonth">December 2024</h4>
                                    <button class="btn-ghost calendar-nav" id="nextMonth" aria-label="Next month">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="calendar-grid">
                                    <div class="calendar-weekdays">
                                        <div class="weekday">Sun</div>
                                        <div class="weekday">Mon</div>
                                        <div class="weekday">Tue</div>
                                        <div class="weekday">Wed</div>
                                        <div class="weekday">Thu</div>
                                        <div class="weekday">Fri</div>
                                        <div class="weekday">Sat</div>
                                    </div>
                                    <div class="calendar-days" id="calendarDays">
                                        <!-- Calendar days will be generated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activities -->
                    <div class="dashboard-card activities-card">
                        <div class="card-header">
                            <h3><i class="fas fa-history"></i> Recent Activities</h3>
                        </div>
                        <div class="card-content">
                            <div class="activity-feed">
                                <div class="activity-item" data-activity-id="expense-jakarta-001">
                                    <div class="activity-icon expense">
                                        <i class="fas fa-receipt"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Expense Report Approved • Jakarta Trip • $2,450</div>
                                        <div class="activity-meta">
                                            <span class="source-chip traveloka">Traveloka</span>
                                            <span class="sync-chip synced">Synced</span>
                                            <span class="activity-time">2h ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="activity-item" data-activity-id="flight-bandung-001">
                                    <div class="activity-icon booking">
                                        <i class="fas fa-plane"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Flight Booking Confirmed • Bandung Trip • $850</div>
                                        <div class="activity-meta">
                                            <span class="source-chip manual">Manual</span>
                                            <span class="sync-chip failed" onclick="retrySyncActivity('flight-bandung-001')" style="cursor: pointer;" title="Click to retry sync">Failed <i class="fas fa-redo"></i></span>
                                            <span class="activity-time">4h ago</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="activity-item" data-activity-id="vehicle-mileage-002">
                                    <div class="activity-icon vehicle">
                                        <i class="fas fa-car"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Vehicle Mileage Logged • 125 km • $45</div>
                                        <div class="activity-meta">
                                            <span class="source-chip manual">Manual</span>
                                            <span class="sync-chip synced">Synced</span>
                                            <span class="activity-time">1d ago</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>



            <!-- Mobile Quick Actions -->
             <div class="quick-actions-mobile">
                 <button class="fab-main" onclick="toggleActionSheet()" aria-label="Open quick actions menu">
                     <i class="fas fa-plus"></i>
                 </button>
             </div>
 
             <!-- Action Sheet Backdrop -->
             <div class="action-sheet-backdrop" id="actionSheetBackdrop" onclick="closeActionSheet()"></div>
             
             <!-- Action Sheet -->
             <div class="action-sheet" id="actionSheet">
                 <div class="action-sheet-header">
                     <h3>Quick Actions</h3>
                 </div>
                 <button class="action-sheet-item" onclick="closeActionSheet(); window.location.href='vehicle.html#new-log';" aria-label="Log mileage">
                     <i class="fas fa-road"></i>
                     <span>Log mileage</span>
                 </button>
                 <button class="action-sheet-item" onclick="closeActionSheet(); showNotImplementedPopup('Add Expense');" aria-label="Add expense">
                     <i class="fas fa-plus"></i>
                     <span>Add Expense</span>
                 </button>
                 <button class="action-sheet-item" onclick="closeActionSheet(); showNotImplementedPopup('Create MWP');" aria-label="Create MWP">
                     <i class="fas fa-plane"></i>
                     <span>Create MWP</span>
                 </button>
                 <button class="action-sheet-item" onclick="closeActionSheet(); window.location.href='cash-advance.html';" aria-label="Request advance">
                     <i class="fas fa-money-bill"></i>
                     <span>Request Advance</span>
                 </button>
                 <button class="action-sheet-item" onclick="closeActionSheet(); showNotImplementedPopup('Scan Receipts');" aria-label="Scan receipts">
                     <i class="fas fa-camera"></i>
                     <span>Scan Receipts</span>
                 </button>
             </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
             initializeDashboard();
             loadUserPreferences();
             initializeBadges();
             initializeLazyChart();
             checkConvertButtonState();
             initializeUploadDownload();

             // KPI count-up for dashboard tiles (Vehicle logs this month)
             const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
             const duration = 900;
             function animateNumber(el, to) {
                 const start = performance.now();
                 function tick(now) {
                     const p = Math.min(1, (now - start) / duration);
                     const val = Math.round(to * easeOutCubic(p));
                     el.textContent = String(val);
                     if (p < 1) requestAnimationFrame(tick);
                 }
                 requestAnimationFrame(tick);
             }
             document.querySelectorAll('.kpi-number[data-count]').forEach(el => {
                 const to = parseInt(el.getAttribute('data-count'), 10) || 0;
                 animateNumber(el, to);
             });
         });

        // New Upload/Download System
        function initializeUploadDownload() {
            const uploadBtn = document.getElementById('btnUpload');
            const fileInput = document.getElementById('mwpFile');
            const split = document.getElementById('btnDownloadGroup');
            const caret = document.getElementById('btnDownloadCaret');
            const menu = split?.querySelector('.menu');

            // Upload flow - always available
            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    if (!/\.(xlsx|csv)$/i.test(file.name)) {
                        return toast('Only .xlsx or .csv files are allowed');
                    }

                    // Disable upload button and show progress
                    uploadBtn.disabled = true;
                    const spanEl = uploadBtn.querySelector('span');
                    if (spanEl) spanEl.textContent = 'Uploading…';
                    
                    // Fake progress demo — replace with real upload
                    const bar = ensureInlineProgress(uploadBtn);
                    for (let p = 0; p <= 100; p += 15) {
                        await sleep(150);
                        bar.style.width = p + '%';
                    }
                    
                    // Simulate file validation
                    await sleep(500);
                    const validationResult = validateMWPFile(file);
                    
                    if (validationResult.isValid) {
                        toast('MWP uploaded successfully • Data validated ✓');
                        showUploadStatus(file.name);
                    } else {
                        toast('Upload failed • ' + validationResult.errors.join(', '));
                    }
                    
                    // Reset upload button
                    uploadBtn.disabled = false;
                    if (spanEl) spanEl.textContent = 'Upload';
                    
                    // Remove progress bar
                    setTimeout(() => {
                        const progressEl = uploadBtn.closest('.mwp-header-actions')?.querySelector('.inline-progress');
                        if (progressEl) progressEl.remove();
                    }, 1000);
                });
            }

            // Download options - guard for elements that may not exist
            if (split && caret && menu) {
                caret.addEventListener('click', () => {
                    const open = split.classList.toggle('open');
                    caret.setAttribute('aria-expanded', String(open));
                });
                
                menu.addEventListener('click', (e) => {
                    const li = e.target.closest('li');
                    if (!li) return;
                    const template = li.dataset.template;
                    const templateName = li.textContent.trim();
                    
                    // Trigger download
                    downloadTemplate(template, templateName);
                    toast(`Downloading ${templateName}…`);
                    
                    // Close menu
                    split.classList.remove('open');
                    caret.setAttribute('aria-expanded', 'false');
                });

                // Close menu on outside click / Esc
                document.addEventListener('click', (e) => {
                    if (!split.contains(e.target)) {
                        split.classList.remove('open');
                        caret.setAttribute('aria-expanded', 'false');
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        split.classList.remove('open');
                        caret.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        }

        // File validation function
        function validateMWPFile(file) {
            // Simulate file validation - replace with actual validation logic
            const requiredColumns = ['date', 'destination', 'est_cost', 'transport_type'];
            const errors = [];
            
            // Mock validation - in real implementation, parse the file
            const hasValidStructure = Math.random() > 0.2; // 80% success rate for demo
            
            if (!hasValidStructure) {
                errors.push('Missing required columns: ' + requiredColumns.slice(0, 2).join(', '));
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Show upload status
        function showUploadStatus(filename) {
            const mwpCard = document.querySelector('.mwp-summary-card');
            if (!mwpCard) return; // Guard if element doesn't exist
            
            let statusEl = mwpCard.querySelector('.upload-status');
            
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.className = 'upload-status';
                mwpCard.style.position = 'relative';
                mwpCard.appendChild(statusEl);
            }
            
            const now = new Date();
            const timeStr = now.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            statusEl.textContent = `Last uploaded: ${timeStr} • by John`;
        }

        // Enhanced download function
        function downloadTemplate(template, templateName) {
            // Simulate download - replace with actual download logic
            const downloadUrls = {
                'travel-plan': '#travel-plan-template.xlsx',
                'traveloka': '#traveloka-mapping.csv',
                'sample': '#sample-filled.xlsx'
            };
            
            // In real implementation, trigger actual download
            console.log(`Downloading ${template}: ${downloadUrls[template]}`);
            
            // Simulate download completion
            setTimeout(() => {
                toast(`${templateName} downloaded successfully`);
            }, 1500);
        }

        // Helper functions
        function toast(msg) {
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2200);
        }

        function ensureInlineProgress(anchorBtn) {
            let wrap = anchorBtn.closest('.mwp-header-actions').querySelector('.inline-progress');
            if (!wrap) {
                wrap = document.createElement('div');
                wrap.className = 'inline-progress';
                const span = document.createElement('span');
                wrap.appendChild(span);
                anchorBtn.closest('.mwp-header-actions').appendChild(wrap);
            }
            return wrap.firstElementChild;
        }

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        function initializeDashboard() {
            // Initialize filter listeners
            const dateRange = document.getElementById('dateRange');
            const customPeriod = document.getElementById('customPeriod');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            if (dateRange) {
                dateRange.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customPeriod.style.display = 'flex';
                        // Set default dates
                        const today = new Date();
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                        startDate.value = lastMonth.toISOString().split('T')[0];
                        endDate.value = today.toISOString().split('T')[0];
                    } else {
                        customPeriod.style.display = 'none';
                    }
                    refreshDashboardData();
                    saveUserPreferences();
                });
            }
            
            // Add listeners for custom date inputs
            if (startDate) {
                startDate.addEventListener('change', function() {
                    refreshDashboardData();
                    saveUserPreferences();
                });
            }
            
            if (endDate) {
                endDate.addEventListener('change', function() {
                    refreshDashboardData();
                    saveUserPreferences();
                });
            }
        }

        function toggleCurrency() {
            const toggle = document.getElementById('currencyToggle');
            const currentCurrency = toggle.textContent.trim();

            if (currentCurrency.includes('USD')) {
                toggle.innerHTML = '<i class="fas fa-exchange-alt"></i> IDR';
                toggle.setAttribute('aria-pressed', 'true');
                toggle.setAttribute('aria-label', 'Switch currency to USD');
                showNotImplementedPopup('Currency switched to IDR');
            } else {
                toggle.innerHTML = '<i class="fas fa-exchange-alt"></i> USD';
                toggle.setAttribute('aria-pressed', 'false');
                toggle.setAttribute('aria-label', 'Switch currency to IDR');
                showNotImplementedPopup('Currency switched to USD');
            }
            saveUserPreferences();
        }

        function refreshDashboardData() {
            // Simulate data refresh with loading state
            const cards = document.querySelectorAll('.dashboard-card');
            cards.forEach(card => {
                card.style.opacity = '0.7';
            });
            
            setTimeout(() => {
                cards.forEach(card => {
                    card.style.opacity = '1';
                });
                showNotImplementedPopup('Dashboard data refreshed');
            }, 500);
        }

        function toggleActionSheet() {
             const actionSheet = document.getElementById('actionSheet');
             const backdrop = document.getElementById('actionSheetBackdrop');
             const fabMain = document.querySelector('.fab-main');
             
             actionSheet.classList.add('active');
             backdrop.classList.add('active');
             fabMain.classList.add('active');
             document.body.style.overflow = 'hidden';
         }
 
         function closeActionSheet() {
             const actionSheet = document.getElementById('actionSheet');
             const backdrop = document.getElementById('actionSheetBackdrop');
             const fabMain = document.querySelector('.fab-main');
             
             actionSheet.classList.remove('active');
             backdrop.classList.remove('active');
             fabMain.classList.remove('active');
             document.body.style.overflow = '';
         }

        // Badge management functions
        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (!badge) return;
            
            badge.textContent = count;
            badge.dataset.count = count;
            badge.classList.toggle('hidden', count === 0);
            
            // Update title for accessibility
            const badgeType = badgeId.replace('badge-', '');
            const titles = {
                'approvals': `${count} approvals pending`,
                'expenses': `${count} violations found`,
                'reports': `${count} reports pending`
            };
            badge.setAttribute('title', titles[badgeType] || `${count} items`);
        }
        
        // Toast notification system (unified with new system)
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                // Fallback to old system if container not found
                toast(message);
                return;
            }
            
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = message;
            el.setAttribute('role', 'alert');
            el.setAttribute('aria-live', 'polite');
            
            toastContainer.appendChild(el);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (el.parentNode) {
                    el.remove();
                }
            }, duration);
        }
        
        // LocalStorage persistence
        function saveUserPreferences() {
            const currency = document.getElementById('currencyToggle').textContent.includes('USD') ? 'USD' : 'IDR';
            const dateRange = document.getElementById('dateRange').value;
            
            localStorage.setItem('travel_currency', currency);
            localStorage.setItem('travel_date_range', dateRange);
        }
        
        function loadUserPreferences() {
            const savedCurrency = localStorage.getItem('travel_currency');
            const savedDateRange = localStorage.getItem('travel_date_range');
            
            if (savedCurrency && savedCurrency !== 'USD') {
                const toggle = document.getElementById('currencyToggle');
                toggle.innerHTML = '<i class="fas fa-exchange-alt"></i> IDR';
            }
            if (savedDateRange) {
                document.getElementById('dateRange').value = savedDateRange;
            }
        }
        
        // Retry sync functionality
         function retrySyncActivity(activityId) {
             showToast('Retrying sync...', 'info', 2000);
             
             // Simulate API call
             setTimeout(() => {
                 const success = Math.random() > 0.3; // 70% success rate
                 if (success) {
                     showToast('Sync successful!', 'success');
                     // Update activity status in UI
                     const failedChip = document.querySelector(`[data-activity-id="${activityId}"] .sync-chip.failed`);
                     if (failedChip) {
                         failedChip.className = 'sync-chip synced';
                         failedChip.innerHTML = 'Synced';
                     }
                 } else {
                     showToast('Sync failed. Please try again.', 'error');
                 }
             }, 1500);
         }
         
         // Loading skeleton for activities
         function showActivitySkeleton() {
             const activityFeed = document.querySelector('.activity-feed');
             const skeletonHTML = `
                 <div class="activity-skeleton">
                     <div class="skeleton-icon"></div>
                     <div class="skeleton-content">
                         <div class="skeleton-line medium"></div>
                         <div class="skeleton-line short"></div>
                     </div>
                 </div>
             `.repeat(3);
             activityFeed.innerHTML = skeletonHTML;
         }
         
         // Simulate loading activities
         function loadActivities() {
             showActivitySkeleton();
             
             // Simulate API delay
             setTimeout(() => {
                 // Restore original content (in real app, this would be populated from API)
                 location.reload();
             }, 2000);
         }
         
         // Initialize badge counts from API (simulated)
         function initializeBadges() {
             // Simulate API call to get current counts
             setTimeout(() => {
                 updateBadge('badge-approvals', 5);
                 updateBadge('badge-expenses', 3);
             }, 500);
         }
         
         // Convert single trip function
         function convertSingleTrip(tripId) {
             showToast('Converting trip...', 'info', 2000);
             
             setTimeout(() => {
                 showToast('Trip converted successfully!', 'success');
                 // In real app, would update UI to reflect conversion
             }, 1500);
         }
         
         // Convert all approved trips
         function convertAllTrips() {
             const approvedTrips = document.querySelectorAll('.trip-item[data-status="approved"]');
             const convertBtn = document.getElementById('convertAllBtn');
             
             if (approvedTrips.length === 0) {
                 convertBtn.disabled = true;
                 convertBtn.title = 'No approved plan to convert';
                 showToast('No approved trips to convert', 'warning');
                 return;
             }
             
             showToast(`Converting ${approvedTrips.length} approved trips...`, 'info', 2000);
             
             setTimeout(() => {
                 showToast('All trips converted successfully!', 'success');
                 // In real app, would update UI to reflect conversions
             }, 2000);
         }
         

         

         
         // Lazy render budget chart
         function initializeLazyChart() {
             const budgetCard = document.querySelector('.budget-breakdown');
             if (!budgetCard) return;
             
             const observer = new IntersectionObserver((entries) => {
                 entries.forEach(entry => {
                     if (entry.isIntersecting) {
                         setTimeout(() => {
                             renderBudgetChart();
                         }, 150); // 150ms delay for smooth FPS
                         observer.unobserve(entry.target);
                     }
                 });
             });
             
             observer.observe(budgetCard);
         }
         
         // Render budget chart (simulated)
         function renderBudgetChart() {
             const chartContainer = document.querySelector('.budget-breakdown');
             if (chartContainer && !chartContainer.dataset.rendered) {
                 chartContainer.dataset.rendered = 'true';
                 // Chart rendering would happen here
                 console.log('Budget chart rendered with lazy loading');
             }
         }
         
         // Check convert button state
        function checkConvertButtonState() {
            const approvedTrips = document.querySelectorAll('.trip-item[data-status="approved"]');
            const convertBtn = document.getElementById('convertAllBtn');
            
            if (convertBtn) {
                if (approvedTrips.length === 0) {
                    convertBtn.disabled = true;
                    convertBtn.title = 'No approved plan to convert';
                } else {
                    convertBtn.disabled = false;
                    convertBtn.title = 'Convert all approved trips';
                }
            }
        }
        
        // Toggle user menu
        function toggleUserMenu() {
            // Placeholder for user menu functionality
            // In a real app, this would show/hide a dropdown menu
            console.log('User menu toggled');
            showToast('User menu - Coming soon!', 'info');
        }
        
        // Toggle agenda view between list and calendar
        function toggleAgendaView() {
            const toggleBtn = document.getElementById('agendaViewToggle');
            const timeline = document.querySelector('.agenda-timeline');
            const calendar = document.querySelector('.agenda-calendar');
            
            if (toggleBtn.textContent.includes('Calendar view')) {
                // Switch to calendar view
                timeline.style.display = 'none';
                calendar.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-list"></i> List view';
                toggleBtn.title = 'Switch to list view';
                toggleBtn.setAttribute('aria-label', 'Switch to list view');
                generateCalendar();
                showToast('Switched to calendar view', 'success');
            } else {
                // Switch to list view
                timeline.style.display = 'block';
                calendar.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-calendar"></i> Calendar view';
                toggleBtn.title = 'Switch to calendar view';
                toggleBtn.setAttribute('aria-label', 'Switch to calendar view');
                showToast('Switched to list view', 'success');
            }
        }
        
        let currentCalendarDate = new Date();
        
        function generateCalendar() {
            const currentMonth = currentCalendarDate.getMonth();
            const currentYear = currentCalendarDate.getFullYear();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            const todayDate = today.getDate();
            
            // Update month header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // Sample events data
            const events = {
                15: [{type: 'travel', title: 'Jakarta Trip'}],
                16: [{type: 'expense', title: 'Receipt deadline'}],
                18: [{type: 'advance', title: 'Advance repayment'}],
                20: [{type: 'deadline', title: 'Report due'}]
            };
            
            // Add previous month's trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day other-month';
                dayDiv.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
                calendarDays.appendChild(dayDiv);
            }
            
            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (isCurrentMonth && day === todayDate) dayDiv.classList.add('today');
                
                // Add click handler for day selection
                dayDiv.addEventListener('click', () => showDayAgenda(currentYear, currentMonth, day));
                
                let dayHTML = `<div class="day-number">${day}</div>`;
                
                if (events[day]) {
                    dayDiv.classList.add('has-events');
                    dayHTML += '<div class="day-events">';
                    events[day].forEach(event => {
                        dayHTML += `<div class="event-item"><span class="event-dot ${event.type}"></span>${event.title}</div>`;
                    });
                    dayHTML += '</div>';
                }
                
                dayDiv.innerHTML = dayHTML;
                calendarDays.appendChild(dayDiv);
            }
            
            // Add next month's leading days to fill the grid
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6 rows × 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day other-month';
                dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
                calendarDays.appendChild(dayDiv);
            }
        }
        
        function prevMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            generateCalendar();
        }
        
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            generateCalendar();
        }
        
        function showDayAgenda(year, month, day) {
            const selectedDate = new Date(year, month, day);
            const dateStr = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Sample agenda for the selected day
            const agendaItems = [
                { time: '09:00', title: 'Flight to Jakarta', type: 'travel' },
                { time: '14:00', title: 'Submit expense report', type: 'deadline' },
                { time: '16:00', title: 'Advance repayment due', type: 'advance' }
            ];
            
            let agendaHTML = `<h4>Agenda for ${dateStr}</h4>`;
            if (agendaItems.length > 0) {
                agendaHTML += '<div class="day-agenda-list">';
                agendaItems.forEach(item => {
                    agendaHTML += `
                        <div class="agenda-item">
                            <span class="agenda-time">${item.time}</span>
                            <span class="event-dot ${item.type}"></span>
                            <span class="agenda-title">${item.title}</span>
                        </div>
                    `;
                });
                agendaHTML += '</div>';
            } else {
                agendaHTML += '<p class="no-agenda">No events scheduled for this day.</p>';
            }
            
            // Show in a simple modal or toast
            showToast(`Selected: ${dateStr}`, 'info', 2000);
        }
    </script>
</body>
</html>
