<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Rules Configuration - TrevID</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img 
                    class="brand-logo" 
                    src="/assets/brand/trevid_logo.png" 
                    srcset="/assets/brand/trevid_logo.png 1x, /assets/brand/trevid_logo@2x.png 2x" 
                    alt="TrevID â€“ Business Companion" 
                    width="140" height="36" />
            </div>
            <div class="user-info">
                <span>Hello, Admin User</span>
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </header>

    <div class="container-fluid mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="admin.html">Admin</a></li>
                <li class="breadcrumb-item"><a href="admin.html">Policies</a></li>
                <li class="breadcrumb-item active">Receipt Rules</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="admin-page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-receipt"></i>Receipt Rules Configuration</h1>
                    <p>Configure receipt requirements and validation rules</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="exportRules()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-primary" onclick="showAddRuleModal()">
                        <i class="fas fa-plus me-1"></i>Add Rule
                    </button>
                </div>
            </div>
        </div>

        <!-- Rule Categories -->
        <div class="admin-overview-cards">
            <div class="admin-overview-card">
                <div class="display-6 text-primary mb-2">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <h5 class="card-title">Amount Thresholds</h5>
                <p class="card-text">Rules based on expense amounts</p>
                <span class="badge bg-primary" id="amountRulesCount">5 rules</span>
            </div>
            <div class="admin-overview-card">
                <div class="display-6 text-success mb-2">
                    <i class="fas fa-tags"></i>
                </div>
                <h5 class="card-title">Category Rules</h5>
                <p class="card-text">Rules by expense category</p>
                <span class="badge bg-success" id="categoryRulesCount">8 rules</span>
            </div>
            <div class="admin-overview-card">
                <div class="display-6 text-warning mb-2">
                    <i class="fas fa-file-image"></i>
                </div>
                <h5 class="card-title">Format Rules</h5>
                <p class="card-text">Receipt format requirements</p>
                <span class="badge bg-warning" id="formatRulesCount">3 rules</span>
            </div>
            <div class="admin-overview-card">
                <div class="display-6 text-info mb-2">
                    <i class="fas fa-clock"></i>
                </div>
                <h5 class="card-title">Time Rules</h5>
                <p class="card-text">Time-based requirements</p>
                <span class="badge bg-info" id="timeRulesCount">2 rules</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card admin-filter-card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Rule Type</label>
                        <select class="form-select" id="typeFilter" onchange="filterRules()">
                            <option value="">All Types</option>
                            <option value="amount">Amount Threshold</option>
                            <option value="category">Category</option>
                            <option value="format">Format</option>
                            <option value="time">Time</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter" onchange="filterRules()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="priorityFilter" onchange="filterRules()">
                            <option value="">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search rules..." oninput="filterRules()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Receipt Rules Table -->
        <div class="card admin-table-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Receipt Rules</h5>
                <span class="badge bg-primary" id="rulesCount">18 rules configured</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Rule Name</th>
                                <th>Type</th>
                                <th>Condition</th>
                                <th>Requirement</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rulesTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Rule Modal -->
    <div class="modal fade" id="ruleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ruleModalTitle">Add Receipt Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ruleForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Rule Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="ruleName" placeholder="Enter rule name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Rule Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="ruleType" onchange="updateConditionFields()" required>
                                    <option value="">Select Type</option>
                                    <option value="amount">Amount Threshold</option>
                                    <option value="category">Category</option>
                                    <option value="format">Format</option>
                                    <option value="time">Time</option>
                                </select>
                            </div>
                            
                            <!-- Dynamic condition fields -->
                            <div id="conditionFields" class="col-12">
                                <!-- Fields will be populated based on rule type -->
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Requirement <span class="text-danger">*</span></label>
                                <select class="form-select" id="requirement" required>
                                    <option value="">Select Requirement</option>
                                    <option value="mandatory">Receipt Mandatory</option>
                                    <option value="optional">Receipt Optional</option>
                                    <option value="justification">Justification Required</option>
                                    <option value="approval">Manager Approval Required</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Priority <span class="text-danger">*</span></label>
                                <select class="form-select" id="priority" required>
                                    <option value="">Select Priority</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isActive" checked>
                                    <label class="form-check-label" for="isActive">
                                        Active
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="3" placeholder="Rule description and additional notes..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRule()">Save Rule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sample data
        let receiptRules = [
            {
                id: 1,
                name: 'High Amount Receipt Required',
                type: 'amount',
                condition: 'amount > 1000000',
                conditionData: { operator: '>', amount: 1000000, currency: 'IDR' },
                requirement: 'mandatory',
                priority: 'high',
                status: 'active',
                description: 'Receipt mandatory for expenses above 1M IDR'
            },
            {
                id: 2,
                name: 'Meal Receipt Optional',
                type: 'category',
                condition: 'category = Meals',
                conditionData: { category: 'Meals' },
                requirement: 'optional',
                priority: 'low',
                status: 'active',
                description: 'Receipt optional for meal expenses under certain amount'
            },
            {
                id: 3,
                name: 'Transport Receipt Required',
                type: 'category',
                condition: 'category = Transportation',
                conditionData: { category: 'Transportation' },
                requirement: 'mandatory',
                priority: 'medium',
                status: 'active',
                description: 'Receipt always required for transportation expenses'
            },
            {
                id: 4,
                name: 'PDF Format Only',
                type: 'format',
                condition: 'format = PDF',
                conditionData: { formats: ['PDF'] },
                requirement: 'mandatory',
                priority: 'medium',
                status: 'active',
                description: 'Only PDF receipts accepted for certain categories'
            },
            {
                id: 5,
                name: 'Same Day Submission',
                type: 'time',
                condition: 'submission within 1 day',
                conditionData: { timeframe: 1, unit: 'days' },
                requirement: 'justification',
                priority: 'high',
                status: 'active',
                description: 'Justification required if not submitted within 1 day'
            }
        ];

        let filteredRules = [...receiptRules];
        let editingRuleId = null;

        function renderRulesTable() {
            const tbody = document.getElementById('rulesTableBody');
            tbody.innerHTML = '';

            filteredRules.forEach(rule => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="fw-medium">${rule.name}</div>
                        <small class="text-muted">${rule.description}</small>
                    </td>
                    <td>
                        <span class="badge bg-${getTypeBadgeColor(rule.type)}">
                            ${rule.type.charAt(0).toUpperCase() + rule.type.slice(1)}
                        </span>
                    </td>
                    <td>
                        <code class="small">${rule.condition}</code>
                    </td>
                    <td>
                        <span class="badge bg-${getRequirementBadgeColor(rule.requirement)}">
                            ${formatRequirement(rule.requirement)}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${getPriorityBadgeColor(rule.priority)}">
                            ${rule.priority.charAt(0).toUpperCase() + rule.priority.slice(1)}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${rule.status === 'active' ? 'success' : 'secondary'}">
                            ${rule.status.charAt(0).toUpperCase() + rule.status.slice(1)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editRule(${rule.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${rule.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateRuleCounts();
        }

        function getTypeBadgeColor(type) {
            const colors = {
                'amount': 'primary',
                'category': 'success',
                'format': 'warning',
                'time': 'info'
            };
            return colors[type] || 'secondary';
        }

        function getRequirementBadgeColor(requirement) {
            const colors = {
                'mandatory': 'danger',
                'optional': 'success',
                'justification': 'warning',
                'approval': 'info'
            };
            return colors[requirement] || 'secondary';
        }

        function getPriorityBadgeColor(priority) {
            const colors = {
                'high': 'danger',
                'medium': 'warning',
                'low': 'success'
            };
            return colors[priority] || 'secondary';
        }

        function formatRequirement(requirement) {
            const formats = {
                'mandatory': 'Mandatory',
                'optional': 'Optional',
                'justification': 'Justification',
                'approval': 'Approval'
            };
            return formats[requirement] || requirement;
        }

        function updateRuleCounts() {
            const counts = {
                amount: filteredRules.filter(r => r.type === 'amount').length,
                category: filteredRules.filter(r => r.type === 'category').length,
                format: filteredRules.filter(r => r.type === 'format').length,
                time: filteredRules.filter(r => r.type === 'time').length
            };

            document.getElementById('amountRulesCount').textContent = `${counts.amount} rules`;
            document.getElementById('categoryRulesCount').textContent = `${counts.category} rules`;
            document.getElementById('formatRulesCount').textContent = `${counts.format} rules`;
            document.getElementById('timeRulesCount').textContent = `${counts.time} rules`;
            document.getElementById('rulesCount').textContent = `${filteredRules.length} rules configured`;
        }

        function filterRules() {
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredRules = receiptRules.filter(rule => {
                const typeMatch = !typeFilter || rule.type === typeFilter;
                const statusMatch = !statusFilter || rule.status === statusFilter;
                const priorityMatch = !priorityFilter || rule.priority === priorityFilter;
                const searchMatch = !searchInput || 
                    rule.name.toLowerCase().includes(searchInput) ||
                    rule.description.toLowerCase().includes(searchInput) ||
                    rule.condition.toLowerCase().includes(searchInput);

                return typeMatch && statusMatch && priorityMatch && searchMatch;
            });

            renderRulesTable();
        }

        function updateConditionFields() {
            const ruleType = document.getElementById('ruleType').value;
            const conditionFields = document.getElementById('conditionFields');
            
            let fieldsHTML = '';
            
            switch(ruleType) {
                case 'amount':
                    fieldsHTML = `
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Operator</label>
                                <select class="form-select" id="amountOperator">
                                    <option value=">">Greater than (>)</option>
                                    <option value=">=">Greater than or equal (>=)</option>
                                    <option value="<">Less than (<)</option>
                                    <option value="<=">Less than or equal (<=)</option>
                                    <option value="=">Equal to (=)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="amountValue" placeholder="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Currency</label>
                                <select class="form-select" id="amountCurrency">
                                    <option value="IDR">IDR</option>
                                    <option value="USD">USD</option>
                                    <option value="SGD">SGD</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                case 'category':
                    fieldsHTML = `
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="categoryValue">
                                    <option value="">Select Category</option>
                                    <option value="Accommodation">Accommodation</option>
                                    <option value="Transportation">Transportation</option>
                                    <option value="Meals">Meals</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Office Supplies">Office Supplies</option>
                                    <option value="Communication">Communication</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                case 'format':
                    fieldsHTML = `
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Allowed Formats</label>
                                <div class="form-check-group">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="formatPDF" value="PDF">
                                        <label class="form-check-label" for="formatPDF">PDF</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="formatJPG" value="JPG">
                                        <label class="form-check-label" for="formatJPG">JPG</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="formatPNG" value="PNG">
                                        <label class="form-check-label" for="formatPNG">PNG</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'time':
                    fieldsHTML = `
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Timeframe</label>
                                <input type="number" class="form-control" id="timeValue" placeholder="1" min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Unit</label>
                                <select class="form-select" id="timeUnit">
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                    <option value="weeks">Weeks</option>
                                    <option value="months">Months</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            conditionFields.innerHTML = fieldsHTML;
        }

        function showAddRuleModal() {
            editingRuleId = null;
            document.getElementById('ruleModalTitle').textContent = 'Add Receipt Rule';
            document.getElementById('ruleForm').reset();
            document.getElementById('conditionFields').innerHTML = '';
            new bootstrap.Modal(document.getElementById('ruleModal')).show();
        }

        function editRule(id) {
            const rule = receiptRules.find(r => r.id === id);
            if (!rule) return;

            editingRuleId = id;
            document.getElementById('ruleModalTitle').textContent = 'Edit Receipt Rule';
            
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleType').value = rule.type;
            document.getElementById('requirement').value = rule.requirement;
            document.getElementById('priority').value = rule.priority;
            document.getElementById('isActive').checked = rule.status === 'active';
            document.getElementById('description').value = rule.description || '';

            updateConditionFields();
            
            // Populate condition-specific fields
            setTimeout(() => {
                if (rule.conditionData) {
                    switch(rule.type) {
                        case 'amount':
                            if (document.getElementById('amountOperator')) {
                                document.getElementById('amountOperator').value = rule.conditionData.operator || '>';
                                document.getElementById('amountValue').value = rule.conditionData.amount || '';
                                document.getElementById('amountCurrency').value = rule.conditionData.currency || 'IDR';
                            }
                            break;
                        case 'category':
                            if (document.getElementById('categoryValue')) {
                                document.getElementById('categoryValue').value = rule.conditionData.category || '';
                            }
                            break;
                    }
                }
            }, 100);

            new bootstrap.Modal(document.getElementById('ruleModal')).show();
        }

        function saveRule() {
            const form = document.getElementById('ruleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const ruleType = document.getElementById('ruleType').value;
            let conditionData = {};
            let condition = '';

            // Build condition based on type
            switch(ruleType) {
                case 'amount':
                    const operator = document.getElementById('amountOperator').value;
                    const amount = document.getElementById('amountValue').value;
                    const currency = document.getElementById('amountCurrency').value;
                    conditionData = { operator, amount: parseFloat(amount), currency };
                    condition = `amount ${operator} ${amount} ${currency}`;
                    break;
                case 'category':
                    const category = document.getElementById('categoryValue').value;
                    conditionData = { category };
                    condition = `category = ${category}`;
                    break;
                case 'format':
                    const formats = [];
                    ['PDF', 'JPG', 'PNG'].forEach(format => {
                        const checkbox = document.getElementById(`format${format}`);
                        if (checkbox && checkbox.checked) {
                            formats.push(format);
                        }
                    });
                    conditionData = { formats };
                    condition = `format in [${formats.join(', ')}]`;
                    break;
                case 'time':
                    const timeValue = document.getElementById('timeValue').value;
                    const timeUnit = document.getElementById('timeUnit').value;
                    conditionData = { timeframe: parseInt(timeValue), unit: timeUnit };
                    condition = `submission within ${timeValue} ${timeUnit}`;
                    break;
            }

            const ruleData = {
                name: document.getElementById('ruleName').value,
                type: ruleType,
                condition: condition,
                conditionData: conditionData,
                requirement: document.getElementById('requirement').value,
                priority: document.getElementById('priority').value,
                status: document.getElementById('isActive').checked ? 'active' : 'inactive',
                description: document.getElementById('description').value
            };

            if (editingRuleId) {
                const index = receiptRules.findIndex(r => r.id === editingRuleId);
                receiptRules[index] = { ...receiptRules[index], ...ruleData };
            } else {
                const newRule = {
                    id: Math.max(...receiptRules.map(r => r.id)) + 1,
                    ...ruleData
                };
                receiptRules.push(newRule);
            }

            bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
            filterRules();
            showNotification(editingRuleId ? 'Rule updated successfully!' : 'Rule added successfully!', 'success');
        }

        function deleteRule(id) {
            if (confirm('Are you sure you want to delete this receipt rule?')) {
                receiptRules = receiptRules.filter(r => r.id !== id);
                filterRules();
                showNotification('Rule deleted successfully!', 'success');
            }
        }

        function exportRules() {
            // Mock export functionality
            showNotification('Export feature will be available soon!', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderRulesTable();
        });
    </script>
</body>
</html>